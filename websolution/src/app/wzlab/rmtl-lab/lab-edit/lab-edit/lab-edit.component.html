<div class="container-fluid mt-2">
  <div class="card shadow">
    <div class="card-header text-white" style="background-color: #151433; font-weight: bold;">
      <h5 class="mb-0">Edit Laboratory Information</h5>
    </div>

    <div class="card-body bg-light">
      <!-- NOTE: use Preview flow -->
      <form (ngSubmit)="openPreview(labForm)" #labForm="ngForm" novalidate>
        <div class="row">
          <div class="col-md-6">
              <div class="col-md-9">
                  <label for="lab_name" class="col-form-label fw-bold">Laboratory Name</label>
                <input
                  type="text"
                  id="lab_name"
                  name="lab_name"
                  [(ngModel)]="lab.lab_name"
                  class="form-control"
                  required
                  placeholder="Enter lab name"
                  [class.is-invalid]="(labForm.submitted || touched['lab_name']) && !lab.lab_name"
                  (blur)="touched['lab_name'] = true"  readonly/>
                <div class="invalid-feedback">Lab Name is required.</div>
              </div>
          </div>

          <div class="col-md-6">
                   <label for="lab_location" class="col-form-label fw-bold">Laboratory Location</label>
                <input
                  type="text"
                  id="lab_location"
                  name="lab_location"
                  [(ngModel)]="lab.lab_location"
                  class="form-control"
                  required
                  placeholder="Enter location"
                  [class.is-invalid]="(labForm.submitted || touched['lab_location']) && !lab.lab_location"
                  (blur)="touched['lab_location'] = true" />
                <div class="invalid-feedback">Location is required.</div>
              </div>
      
          <div class="col-md-6">

                   <label for="status" class="col-form-label fw-bold">Laboratory Status</label>
                <select
                  id="status"
                  name="status"
                  [(ngModel)]="lab.status"
                  class="form-select"
                  required
                  [class.is-invalid]="(labForm.submitted || touched['status']) && !lab.status"
                  (blur)="touched['status'] = true">
                  <option value="" disabled>Select status</option>
                  <option *ngFor="let s of lab_statuses" [value]="s">{{ s | titlecase }}</option>
                </select>
                <div class="invalid-feedback">Status is required.</div>
              </div> 
          <div class="col-md-6">
            <!-- Lab Type (required) -->
                  <label for="lab_type" class="col-form-label fw-bold">Laboratory Type</label>
                <select
                  id="lab_type"
                  name="lab_type"
                  class="form-select"
                  [(ngModel)]="lab.lab_type"
                  required
                  [class.is-invalid]="(labForm.submitted || touched['lab_type']) && !lab.lab_type"
                  (blur)="touched['lab_type'] = true"
                >
                  <option value="" disabled>Select type</option>
                  <option *ngFor="let labtype of labtypes" [value]="labtype">{{ labtype }}</option>
                </select>
                <div class="invalid-feedback">Lab Type is required.</div>
              </div>
            </div>
      

        <!-- PDF Header (Optional) -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="border rounded p-3 bg-white">
              <h6 class="fw-bold mb-3">PDF Header Laboratory Information</h6>

              <div class="row g-3">
                <div class="col-md-6">
                  <label for="lab_pdfheader_name" class="form-label">Header Laboratory Name</label>
                  <input
                    id="lab_pdfheader_name"
                    name="lab_pdfheader_name"
                    [(ngModel)]="lab.lab_pdfheader_name"
                    type="text"
                    class="form-control"                  
                  />
                </div>

                <div class="col-md-6">
                  <label for="lab_pdfheader_email" class="form-label">Header Laboratory Email</label>
                  <input
                    id="lab_pdfheader_email"
                    name="lab_pdfheader_email"
                    [(ngModel)]="lab.lab_pdfheader_email"
                    type="email"
                    class="form-control"
                  />
                </div>

                <div class="col-md-8">
                  <label for="lab_pdfheader_address" class="form-label">Header Laboratory Address</label>
                  <input
                    id="lab_pdfheader_address"
                    name="lab_pdfheader_address"
                    [(ngModel)]="lab.lab_pdfheader_address"
                    type="text"
                    class="form-control"
      />
                </div>

                <div class="col-md-4">
                  <label for="lab_pdfheader_contact_no" class="form-label">Header Laboratory Contact No.</label>
                  <input
                    id="lab_pdfheader_contact_no"
                    name="lab_pdfheader_contact_no"
                    [(ngModel)]="lab.lab_pdfheader_contact_no"
                    type="text"
                    class="form-control"
                    placeholder="eg. 0731-29978514"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="row mt-3">
          <div class="col-md-12 text-end">
            <button type="submit" class="btn btn-success me-2" [disabled]="loading">
              <i class="fas fa-eye me-1"></i> Preview Update
            </button>
            <button type="button" class="btn btn-secondary" (click)="cancel()" [disabled]="loading">
              <i class="fas fa-times me-1"></i> Cancel
            </button>
            <span *ngIf="loading" class="spinner-border spinner-border-sm text-success ms-2" role="status"></span>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" #previewModal tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0" style="background:#151433; color:#fff;">
        <h5 class="modal-title fw-bold" id="previewModalLabel">
          <i class="fas fa-search me-2"></i>Confirm Changes
        </h5>
        <button type="button" class="btn-close" (click)="closePreview()" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="list-group">
          <div class="list-group-item d-flex justify-content-between">
            <span class="fw-semibold">Laboratory Name</span>
            <span>{{ lab.lab_name || '—' }}</span>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="fw-semibold"> laboratory Location</span>
            <span>{{ lab.lab_location || '—' }}</span>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="fw-semibold"> laboratory Status</span>
            <span>
              <span *ngIf="lab.status; else noStatus" class="badge bg-info text-dark">{{ lab.status }}</span>
              <ng-template #noStatus>—</ng-template>
            </span>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="fw-semibold"> laboratory Type</span>
            <span>{{ lab.lab_type || '—' }}</span>
          </div>

          <div class="list-group-item">
            <div class="fw-semibold mb-2">PDF Header Information</div>
            <div class="small">
              <div><strong> Laboratory Name:</strong> {{ lab.lab_pdfheader_name || '—' }}</div>
              <div><strong> laboratory Email:</strong> {{ lab.lab_pdfheader_email || '—' }}</div>
              <div><strong> laboratory Address:</strong> {{ lab.lab_pdfheader_address || '—' }}</div>
              <div><strong> laboratory Contact:</strong> {{ lab.lab_pdfheader_contact_no || '—' }}</div>
            </div>
          </div>
        </div>

        <div class="alert alert-warning mt-3 mb-0" *ngIf="!lab.lab_name || !lab.lab_location || !lab.status">
          <i class="fas fa-exclamation-triangle me-1"></i>
          Some required fields are missing. Please close and complete them.
        </div>
      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" (click)="closePreview()">Cancel</button>
        <button
          type="button"
          class="btn btn-success"
          (click)="onConfirmUpdate()"
          [disabled]="!lab.lab_name || !lab.lab_location || !lab.status || loading">
          <i class="fas fa-save me-1"></i> Update
          <span *ngIf="loading" class="spinner-border spinner-border-sm ms-2" role="status"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Alert Modal (Success / Error) -->
<div class="modal fade" #alertModal tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" [ngClass]="{ 'border-success': responseSuccess, 'border-danger': !responseSuccess }">
      <div class="modal-header border-0" style="background:#151433; color:#fff;">
        <h5 class="modal-title fw-bold" id="alertModalLabel">
          <span class="ms-2">{{ responseSuccess ? 'Done' : 'Error' }}</span>
        </h5>
        <button type="button" class="btn-close" (click)="closeAlert()" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p class="mb-0">{{ responseMessage }}</p>
      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn" [ngClass]="responseSuccess ? 'btn-success' : 'btn-danger'" (click)="closeAlert()">
          OK
        </button>
      </div>
    </div>
  </div>
</div>
