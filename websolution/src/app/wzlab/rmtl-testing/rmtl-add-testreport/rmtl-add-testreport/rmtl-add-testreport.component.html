<div class="container-fluid mt-4">
  <div class="card shadow">
    <div class="card-header text-white" style="background:#151433">
      <h5 class="mb-0">RMTL ‚Äî Generate Testing Reports</h5>
    </div>

    <div class="card-body">
      <!-- Top controls -->
      <div class="d-print-none">
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-lg-6">
                <label class="form-label fw-bold">Generate Test Report Type</label>
                <select class="form-select" [(ngModel)]="reportType" name="reportType">
                  <option *ngFor="let t of reportTypes" [value]="t">{{ t }}</option>
                </select>
              </div>
              <div class="col-lg-6 d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" (click)="openConfirm('reload')">
                  ‚ü≥ Reload Assigned
                </button>
                <button class="btn btn-dark" type="button" (click)="print()">üñ® Print</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ===================== A) Batch Sheet form ====================== -->
        <form class="card shadow-sm mb-3"
              *ngIf="reportType==='stopdefective' || reportType==='contested'"
              #batchForm="ngForm">
          <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
            <div class="fw-bold">Stop Defective / Contested ‚Äî Test Report</div>
            <div class="small text-muted">
              Total <span class="badge bg-secondary">{{ totalCount }}</span>
              Matched <span class="badge bg-success">{{ matchedCount }}</span>
              Unknown <span class="badge bg-danger">{{ unknownCount }}</span>
            </div>
          </div>

          <div class="card-body">
            <!-- Top bar -->
            <div class="row g-3 mb-2">
              <div class="col-md-3">
                <label class="form-label fw-bold">Test Method</label>
                <select class="form-select" [(ngModel)]="testMethod" name="b_test_method">
                  <option *ngFor="let method of test_methods" [value]="method">{{ method }}</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold">Test Status</label>
                <select class="form-select" [(ngModel)]="testStatus" name="b_test_status">
                  <option *ngFor="let s of test_statuses" [value]="s">{{ s }}</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold">Filter Rows</label>
                <input class="form-control" [(ngModel)]="filterText" name="filterText"
                       placeholder="Search serial / make / capacity / remark">
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold">Testing Date</label>
                <input type="date" class="form-control" [(ngModel)]="batch.header.date" name="batch_date" required>
              </div>
            </div>

            <!-- Batch header / source -->
            <div class="row g-3 mb-2">
              <div class="col-md-4">
                <label class="form-label fw-bold">Phase</label>
                <select class="form-select" [(ngModel)]="batch.header.phase" name="batch_phase">
                  <option [ngValue]="''" disabled>Select‚Ä¶</option>
                  <option *ngFor="let phase of phases" [value]="phase">{{ phase }}</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label fw-bold">Source Type</label>
                <select class="form-select" [(ngModel)]="selectedSourceType" name="source_type"
                        (change)="onSourceTypeChange()">
                  <option [ngValue]="''" disabled>Select‚Ä¶</option>
                  <option *ngFor="let type of office_types" [value]="type">{{ type }}</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label fw-bold">Location/Store/Vendor Code</label>
                <div class="input-group">
                  <input type="text" class="form-control" [(ngModel)]="selectedSourceName" name="source_name"
                         (keydown.enter)="openConfirm('fetch')">
                  <button class="btn btn-outline-primary" type="button" (click)="openConfirm('fetch')">Fetch</button>
                </div>
              </div>

              <!-- Source & Assigned preview (uses existing data only) -->
              <div class="col-12" *ngIf="filteredSources">
                <div class="alert alert-info py-2 px-3 mb-2">
                  <div class="d-flex flex-wrap align-items-center gap-3">
                    <div><strong>Source:</strong> {{ filteredSources?.name || selectedSourceName }}</div>
                    <div><strong>Type:</strong> {{ selectedSourceType || '-' }}</div>
                    <div><strong>Phase:</strong> {{ batch.header.phase || '-' }}</div>
                    <div><strong>Date:</strong> {{ batch.header.date || '-' }}</div>
                  </div>
                </div>

                <!-- Assigned devices quick preview from batch.rows -->
                <div class="table-responsive">
                  <table class="table table-sm table-bordered align-middle text-center">
                    <thead class="table-light">
                      <tr>
                        <th style="width:48px;">#</th>
                        <th>Serial</th>
                        <th>Make</th>
                        <th>Capacity</th>
                        <th>Assignment ID</th>
                        <th>Device ID</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let r of batch.rows; let i = index">
                        <td>{{ i + 1 }}</td>
                        <td class="text-start">{{ r.serial || '-' }}</td>
                        <td class="text-start">{{ r.make || '-' }}</td>
                        <td class="text-start">{{ r.capacity || '-' }}</td>
                        <td>{{ r.assignment_id || '-' }}</td>
                        <td>{{ r.device_id || '-' }}</td>
                      </tr>
                      <tr *ngIf="!batch.rows?.length">
                        <td colspan="6" class="text-muted">No assigned devices loaded. Use ‚ÄúReload Assigned‚Äù.</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Rows to fill & submit -->
            <div class="table-responsive mt-3">
              <table class="table table-hover table-bordered align-middle">
                <thead class="table-light text-center sticky-top" style="top:0; z-index:1;">
                  <tr>
                    <th style="width:64px;">#</th>
                    <th style="min-width:180px;">Meter Serial</th>
                    <th style="min-width:160px;">Make</th>
                    <th style="min-width:140px;">Capacity</th>
                    <th style="min-width:220px;">Result / Remarks</th>
                    <th style="min-width:120px;">Test Result</th>
                    <th class="d-print-none" style="width:72px;">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let r of displayRows(); let i = index; trackBy: trackRow"
                      [ngClass]="{'table-danger': r.notFound}">
                    <td class="text-center">
                      <span class="badge bg-secondary">{{ i + 1 }}</span>
                    </td>

                    <td>
                      <input class="form-control form-control-sm"
                             [(ngModel)]="r.serial"
                             [name]="'b_serial_' + i"
                             (ngModelChange)="onSerialChanged(i, r.serial)"
                             placeholder="Type serial‚Ä¶"
                             required>
                      <div *ngIf="r.notFound" class="form-text text-danger">
                        Serial not in assigned list
                      </div>
                    </td>

                    <td>
                      <input class="form-control form-control-sm"
                             [(ngModel)]="r.make"
                             [name]="'b_make_' + i"
                             placeholder="auto-filled (editable)">
                    </td>

                    <td>
                      <input class="form-control form-control-sm"
                             [(ngModel)]="r.capacity"
                             [name]="'b_capacity_' + i"
                             placeholder="auto-filled (editable)">
                    </td>

                    <td>
                      <select class="form-select form-select-sm"
                              [(ngModel)]="r.result"
                              [name]="'b_result_' + i">
                        <option value="">--</option>
                        <option *ngFor="let option of comment_bytester" [value]="option">{{ option }}</option>
                      </select>
                    </td>

                    <td>
                      <select class="form-select form-select-sm"
                              [(ngModel)]="r.test_result"
                              [name]="'b_test_result_' + i">
                        <option [ngValue]="undefined">--</option>
                        <option *ngFor="let tr of testResultOptions" [ngValue]="tr">{{ tr }}</option>
                      </select>
                    </td>

                    <td class="text-center d-print-none">
                      <button type="button" class="btn btn-sm btn-outline-danger"
                              (click)="openConfirm('removeRow', { index: i })">‚úï</button>
                    </td>
                  </tr>

                  <tr *ngIf="!displayRows().length">
                    <td colspan="7" class="text-center text-muted">No rows match your filter.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="d-flex flex-wrap gap-2 d-print-none">
              <button type="button" class="btn btn-outline-primary" (click)="addBatchRow()">‚ûï Add Row</button>
              <button type="button" class="btn btn-outline-secondary" (click)="openConfirm('clear')">Clear</button>
              <div class="ms-auto"></div>
              <button type="button" class="btn btn-primary"
                      [disabled]="submitting || !batch.rows.length"
                      (click)="openConfirm('submit')">
                {{ submitting ? 'Submitting‚Ä¶' : 'Submit Batch Report' }}
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- ===================== PRINT AREA ====================== -->
      <div id="printArea" class="paper a4 shadow-sm bg-white p-3">
        <ng-container *ngIf="report_printing==='stopdefective' && filteredSources">
          <div class="text-center">
            <div class="fw-bold" style="font-size:24px;">Madhya Pradesh Pashchim Kshetra Vidyut Vitaran Company Limited</div>
            <div class="fw-bold" style="font-size:17px;">RMTL TESTING LABORATORY INDORE</div>
          </div>

          <div class="row mt-2 small">
            <div class="col-6"><strong>Distribution Center / Zone:</strong> {{ filteredSources?.name || '-' }}</div>
            <div class="col-3"><strong>Device Phase:</strong> {{ batch.header.phase || '-' }}</div>
            <div class="col-3 text-end"><strong>Testing Date:</strong> {{ batch.header.date }}</div>
          </div>

          <table class="table table-bordered table-sm mt-2 align-middle">
            <thead class="table-light text-center">
              <tr>
                <th style="width:42px;">‡§ï‡•ç‡§∞.</th>
                <th>‡§Æ‡•Ä‡§ü‡§∞ ‡§®‡§Ç‡§¨‡§∞</th>
                <th>‡§Æ‡•á‡§ï</th>
                <th>‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ</th>
                <th>‡§™‡§∞‡§ø‡§£‡§æ‡§Æ / Remarks</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of batch.rows; let i = index">
                <td class="text-center">{{ i + 1 }}</td>
                <td>{{ r.serial }}</td>
                <td>{{ r.make }}</td>
                <td>{{ r.capacity }}</td>
                <td>{{ r.result }}</td>
              </tr>
              <tr *ngIf="!batch.rows?.length">
                <td colspan="5" class="text-center text-muted">No rows</td>
              </tr>
            </tbody>
          </table>

          <div class="row mt-4 small">
            <div class="col-6">
              <div class="sig-line">Tested by</div>
              <div>JUNIOR ENGINEER (RMTL)</div>
            </div>
            <div class="col-6 text-end">
              <div class="sig-line d-inline-block">Assistant Engineer</div>
              <div>R.M.T.L., MPPKVVCL</div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- ===================== Reusable Confirm Modal ====================== -->
  <div class="modal fade" tabindex="-1"
       [class.show]="modal.open"
       [style.display]="modal.open ? 'block' : 'none'"
       (click)="closeModal()">
    <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ modal.title }}</h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">{{ modal.message }}</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" (click)="closeModal()">Cancel</button>
          <button class="btn btn-primary" type="button" (click)="confirmModal()">Confirm</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="modal.open"></div>

  <!-- ===================== Loading overlay ====================== -->
  <div *ngIf="loading" class="position-fixed top-0 start-0 w-100 h-100"
       style="background:rgba(0,0,0,0.15); z-index: 1080;">
    <div class="d-flex h-100 align-items-center justify-content-center">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <span class="ms-2 fw-semibold">Loading‚Ä¶</span>
    </div>
  </div>
</div>
