<div class="container-fluid mt-4">
  <div class="card shadow border-0">
    <!-- Header -->
    <div class="card-header py-3" style="background:#151433; color:#fff;">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
        <h5 class="mb-0 text-white d-flex align-items-center gap-2">
          <i class="fas fa-clipboard-list"></i>
          RMTL — View Test Reports
        </h5>

        <div class="d-flex flex-wrap gap-2">
          <span class="badge rounded-pill bg-secondary">From: {{ filters.from || '—' }}</span>
          <span class="badge rounded-pill bg-secondary">To: {{ filters.to || '—' }}</span>
          <span class="badge rounded-pill bg-info text-dark">Total: {{ filtered.length }}</span>
          <span class="badge rounded-pill"
                [ngClass]="{'bg-success': pageRows.length, 'bg-warning text-dark': !pageRows.length}">
            Page: {{ page }} / {{ totalPages || 1 }}
          </span>
        </div>
      </div>
    </div>

    <div class="card-body">

      <!-- Filters -->
      <div class="border rounded-3 p-3 p-md-4 mb-3 bg-light-subtle">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">From</label>
            <input type="date" class="form-control" [(ngModel)]="filters.from" (change)="onDateChanged()">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">To</label>
            <input type="date" class="form-control" [(ngModel)]="filters.to" (change)="onDateChanged()">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Report Type</label>
            <select class="form-select" [(ngModel)]="filters.report_type" (change)="onReportTypeChanged()">
              <option value="">All</option>
              <option *ngFor="let rt of reportTypes" [value]="rt">{{ rt }}</option>
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label fw-semibold">Search by Serial No.</label>
            <input type="text" class="form-control" placeholder="Search by serial no"
                   [(ngModel)]="search_serial" (keydown.enter)="onSearchChanged()">
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-end mt-3">
          <button class="btn btn-outline-secondary" (click)="resetFilters()">
            <i class="fas fa-rotate"></i> Reset
          </button>
          <button class="btn btn-outline-success" (click)="exportCSV()">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
        </div>
      </div>

      <!-- Loading & Error -->
      <div *ngIf="loading" class="alert alert-light border d-flex align-items-center gap-2">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Loading reports…
      </div>
      <div *ngIf="!loading && error" class="alert alert-danger">{{ error }}</div>

      <!-- Table -->
      <div class="table-responsive mt-3">
        <table class="table table-bordered align-middle text-center table-hover mb-3"
               style="--bs-table-bg:#fff; --bs-table-striped-bg:#f8f9fa;">
          <thead class="table-dark position-sticky top-0" style="z-index:1">
            <tr>
              <th style="min-width:56px;">#</th>
              <th>Report ID</th>

              <!-- ✅ new -->
              <th style="min-width:140px;">Serial</th>
              <th style="min-width:120px;">Make</th>
              <th style="min-width:170px;">Inward No</th>
              <th style="min-width:140px;">Bench</th>
              <th style="min-width:110px;">Result</th>

              <th style="min-width:110px;">Method</th>
              <th style="min-width:110px;">Status</th>
              <th style="min-width:90px;">Burned</th>
              <th style="min-width:100px;">Error %</th>
              <th style="min-width:160px;">Report Type</th>
              <th style="min-width:140px;">Actions</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let r of pageRows; let i=index" class="align-middle">
              <td class="text-muted">{{ (page-1)*pageSize + i + 1 }}</td>

              <td>
                <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-2"
                        (click)="downloadTestreports_byreportidwithReportTypes(
                          (r.report_id || r.testing?.report_id)!,
                          (r.report_type || r.testing?.report_type)!
                        )"
                        [disabled]="!(r.report_id || r.testing?.report_id) || !(r.report_type || r.testing?.report_type)"
                        title="Download PDF Report">
                  <i class="fas fa-file-pdf"></i>
                  <span>{{ r.report_id || r.testing?.report_id }}</span>
                </button>
              </td>

              <!-- ✅ new columns -->
              <td>{{ r.serial_number || r.device?.serial_number || '-' }}</td>
              <td>{{ r.make || r.device?.make || '-' }}</td>
              <td>{{ r.inward_no || r.device?.inward_number || '-' }}</td>
              <td>{{ r.testing_bench?.bench_name || r.testing?.testing_bench || '-' }}</td>
              <td>
                <span class="badge rounded-pill bg-success">
                  {{ r.test_result || r.testing?.test_result || '-' }}
                </span>
              </td>

              <td>
                <span class="badge rounded-pill bg-secondary">
                  {{ r.test_method || r.testing?.test_method || '-' }}
                </span>
              </td>

              <td>
                <span class="badge rounded-pill"
                  [ngClass]="{
                    'bg-success': (r.test_status || r.testing?.test_status) === 'COMPLETED',
                    'bg-warning text-dark': (r.test_status || r.testing?.test_status) === 'UNTESTABLE',
                    'bg-secondary': !(r.test_status || r.testing?.test_status)
                  }">
                  {{ r.test_status || r.testing?.test_status || '-' }}
                </span>
              </td>

              <td>
                <span [ngClass]="{
                  'text-danger fw-semibold': (r.is_burned ?? r.testing?.is_burned) === true,
                  'text-success': (r.is_burned ?? r.testing?.is_burned) !== true
                }">
                  {{ (r.is_burned ?? r.testing?.is_burned) ? 'YES' : 'NO' }}
                </span>
              </td>

              <td>
                {{ (r.error_percentage ?? r.testing?.error_percentage) ?? '-' }}
                <span *ngIf="(r.error_percentage ?? r.testing?.error_percentage) !== null && (r.error_percentage ?? r.testing?.error_percentage) !== undefined">%</span>
              </td>

              <td>{{ r.report_type || r.testing?.report_type || '-' }}</td>

              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary"
                          (click)="openDetails(r)"
                          data-bs-toggle="offcanvas"
                          data-bs-target="#detailsCanvas">
                    <i class="fas fa-eye"></i> Details
                  </button>
                </div>
              </td>
            </tr>

            <tr *ngIf="!pageRows.length && !loading && !error">
              <td colspan="15" class="py-4 text-muted">
                <i class="far fa-folder-open me-2"></i>No reports found for selected filters.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination (unchanged) -->
      <div class="rmtl-pager mt-2">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
          <div class="d-flex align-items-center gap-2">
            <label class="small text-muted mb-0">Rows per page</label>
            <select class="form-select form-select-sm w-auto" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
              <option *ngFor="let s of pageSizeOptions" [value]="s">{{ s }}</option>
            </select>
            <span class="small text-muted ms-2">
              Showing {{ filtered.length ? ((page-1)*pageSize + 1) : 0 }}–{{ Math.min(page*pageSize, filtered.length) }} of {{ filtered.length }}
            </span>
          </div>

          <div class="d-none d-md-flex align-items-center gap-2">
            <label class="small text-muted mb-0">Go to</label>
            <input type="number" class="form-control form-control-sm w-auto" [min]="1" [max]="totalPages"
                   [(ngModel)]="gotoInput" (keyup.enter)="goto(gotoInput || 1)">
            <button class="btn btn-sm btn-outline-primary" (click)="goto(gotoInput || 1)">Go</button>
          </div>
        </div>

        <nav class="d-none d-md-block">
          <ul class="pagination pagination-sm justify-content-end mb-0 pagination-rounded shadow-sm">
            <li class="page-item" [class.disabled]="page===1">
              <a class="page-link" (click)="goto(page-1)" aria-label="Previous"><i class="fas fa-angle-left"></i></a>
            </li>

            <li *ngFor="let p of pageWindow"
                class="page-item"
                [class.active]="p===page"
                [class.disabled]="p==='…'">
              <a *ngIf="p!=='…'" class="page-link" (click)="goto(p)">{{ p }}</a>
              <span *ngIf="p==='…'" class="page-link">…</span>
            </li>

            <li class="page-item" [class.disabled]="page===totalPages">
              <a class="page-link" (click)="goto(page+1)" aria-label="Next"><i class="fas fa-angle-right"></i></a>
            </li>
          </ul>
        </nav>

        <div class="d-flex d-md-none align-items-center justify-content-between gap-2 mt-2">
          <button class="btn btn-sm btn-outline-secondary flex-fill" [disabled]="page===1" (click)="goto(page-1)">
            <i class="fas fa-chevron-left me-1"></i> Prev
          </button>

          <select class="form-select form-select-sm" [(ngModel)]="page" (change)="goto(page)">
            <option *ngFor="let p of allPages" [value]="p">Page {{ p }}</option>
          </select>

          <button class="btn btn-sm btn-outline-secondary flex-fill" [disabled]="page===totalPages" (click)="goto(page+1)">
            Next <i class="fas fa-chevron-right ms-1"></i>
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Offcanvas: Details -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="detailsCanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title d-flex align-items-center gap-2">
      <i class="fas fa-file-alt"></i> Report Details
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body" *ngIf="selected as s">
    <!-- badges -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      <span class="badge bg-dark">Report: {{ (s.report_id || s.testing?.report_id) || '-' }}</span>
      <span class="badge bg-primary">Type: {{ s.report_type || s.testing?.report_type || '-' }}</span>
      <span class="badge bg-info text-dark">Status: {{ s.test_status || s.testing?.test_status || '-' }}</span>
      <span class="badge bg-success">Result: {{ s.test_result || s.testing?.test_result || '-' }}</span>
    </div>

    <!-- ✅ structured sections -->
    <div class="border rounded-3 p-2 mb-3">
      <div class="fw-semibold mb-2">Testing</div>
      <div class="small">
        <div><strong>Method:</strong> {{ s.testing?.test_method || s.test_method || '-' }}</div>
        <div><strong>Status:</strong> {{ s.testing?.test_status || s.test_status || '-' }}</div>
        <div><strong>Result:</strong> {{ s.testing?.test_result || s.test_result || '-' }}</div>
        <div><strong>Final remarks:</strong> {{ s.testing?.final_remarks || s.final_remarks || '-' }}</div>
      </div>
    </div>

    <div class="border rounded-3 p-2 mb-3">
      <div class="fw-semibold mb-2">Device</div>
      <div class="small">
        <div><strong>Serial:</strong> {{ s.device?.serial_number || s.serial_number || '-' }}</div>
        <div><strong>Make:</strong> {{ s.device?.make || s.make || '-' }}</div>
        <div><strong>Inward No:</strong> {{ s.device?.inward_number || s.inward_no || '-' }}</div>
        <div><strong>Inward Date:</strong> {{ (s.device?.inward_date || s.inward_date) | date:'yyyy-MM-dd' }}</div>
        <div><strong>Type:</strong> {{ s.device?.device_type || '-' }} / {{ s.device?.device_testing_purpose || '-' }}</div>
        <div><strong>Phase:</strong> {{ s.device?.phase || '-' }}</div>
        <div><strong>Voltage:</strong> {{ s.device?.voltage_rating || '-' }}</div>
        <div><strong>Capacity:</strong> {{ s.device?.capacity || '-' }}</div>
        <div><strong>Meter Category:</strong> {{ s.device?.meter_category || '-' }}</div>
      </div>
    </div>

    <div class="border rounded-3 p-2 mb-3">
      <div class="fw-semibold mb-2">Assignment / Bench</div>
      <div class="small">
        <div><strong>Assignment Status:</strong> {{ s.assignment?.assignment_status || '-' }}</div>
        <div><strong>Bench:</strong> {{ s.testing_bench?.bench_name || '-' }}</div>
        <div><strong>Bench Type:</strong> {{ s.testing_bench?.type || '-' }}</div>
        <div><strong>Operation:</strong> {{ s.testing_bench?.operation_type || '-' }}</div>
      </div>
    </div>

    <!-- ✅ Raw JSON viewer -->
    <details class="mt-2">
      <summary class="fw-semibold">Raw JSON (full response)</summary>
      <pre class="bg-light border rounded-3 p-2 mt-2 small" style="white-space:pre-wrap;">{{ s | json }}</pre>
    </details>
  </div>
</div>
