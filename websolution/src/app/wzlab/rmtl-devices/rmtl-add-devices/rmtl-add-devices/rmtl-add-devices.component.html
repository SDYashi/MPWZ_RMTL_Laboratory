<div class="container-fluid mt-4">
  <div class="card shadow">
    <div class="card-header text-white" style="background-color:#151433;">
      <h5 class="mb-0">Bulk Device Entry</h5>
    </div>

    <div class="card-body">
      <!-- Shared Source & Location (for both Meters & CTs) -->
      <form #sourceForm="ngForm" class="mb-3">
        <div class="row mb-3 border p-4">
          <div class="col-md-4">
            <label class="form-label mt-2 fw-bold">Source Type</label>
            <select class="form-select"
                    [(ngModel)]="selectedSourceType"
                    name="source_type"
                    (change)="onSourceTypeChange()"
                    required>
              <option [ngValue]="''" disabled>Select...</option>
              <option *ngFor="let type of office_types" [value]="type">{{ type }}</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label mt-2 fw-bold"><strong>Location/Store/Vendor Code</strong></label>
            <input type="text"
                   class="form-control"
                   [(ngModel)]="selectedSourceName"
                   name="source_name"
                   required
                   (keydown.enter)="fetchButtonData()">
          </div>

          <div class="col-md-4" style="margin-top: 14px;">
            <button type="button" class="btn btn-primary mt-4" (click)="fetchButtonData()">Fetch</button>
          </div>

          <table class="table table-striped table-bordered mt-3" *ngIf="filteredSources">
            <thead>
              <tr>
                <th>Name</th>
                <th>Division Name</th>
                <th>Code</th>
                <th>Circle Name</th>
                <th>Region Name</th>
                <th>Org Name</th>
                <th>Division Code</th>
                <th>Circle Code</th>
                <th>Region Code</th>
                <th>Org Code</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ filteredSources?.name }}</td>
                <td>{{ filteredSources?.division_name }}</td>
                <td>{{ filteredSources?.code }}</td>
                <td>{{ filteredSources?.circle_name }}</td>
                <td>{{ filteredSources?.region_name }}</td>
                <td>{{ filteredSources?.org_name }}</td>
                <td>{{ filteredSources?.division_code }}</td>
                <td>{{ filteredSources?.circle_code }}</td>
                <td>{{ filteredSources?.region_code }}</td>
                <td>{{ filteredSources?.org_code }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </form>

      <!-- Main Tabs -->
      <ul class="nav nav-tabs custom-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="meter-tab" data-bs-toggle="tab" data-bs-target="#meter" type="button" role="tab" aria-controls="meter" aria-selected="true">
            METERS
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ct-tab" data-bs-toggle="tab" data-bs-target="#ct" type="button" role="tab" aria-controls="ct" aria-selected="false">
            CTs
          </button>
        </li>
      </ul>

      <div class="tab-content mt-3" id="myTabContent">

        <!-- METERS TAB -->
        <div class="tab-pane m-3 border fade show active" id="meter" role="tabpanel" aria-labelledby="meter-tab">
          <h4 class="card-title p-2 bg-dark text-white fw-bold text-primary rounded shadow border">Add Bulk Meters</h4>

          <div class="container-fluid mt-3 bg-light p-4">
            <!-- Meter entry tabs -->
            <ul class="nav nav-tabs custom-tabs mb-3 mt-1" id="entryTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv" type="button" role="tab" aria-controls="csv" aria-selected="true">
                  ðŸ“„ Upload CSV
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="range-tab" data-bs-toggle="tab" data-bs-target="#range" type="button" role="tab" aria-controls="range" aria-selected="false">
                  ðŸ”¢ Serial No Range
                </button>
              </li>
            </ul>

            <div class="tab-content custom-tab-content" id="entryTabContent">
              <!-- Meter CSV Upload -->
              <div class="tab-pane fade show active" id="csv" role="tabpanel" aria-labelledby="csv-tab">
                <div class="p-4 bg-white rounded shadow-sm border">
                  <h6 class="mb-3 text-primary fw-bold">Upload Device List (CSV)</h6>
                  <input type="file" accept=".csv" (change)="handleCSVUpload($event)" class="form-control border-info">
                </div>
              </div>

              <!-- Meter Serial No Range -->
              <div class="tab-pane fade" id="range" role="tabpanel" aria-labelledby="range-tab">
                <div class="p-4 bg-white rounded shadow-sm border">
                  <h6 class="mb-3 text-primary fw-bold">Add Devices by Serial Number Range</h6>

                  <div class="row g-3">
                    <div class="col-md-3">
                      <label class="form-label mt-2 fw-bold">Start Serial</label>
                      <input type="number" [(ngModel)]="serialRange.start" name="serial_start" class="form-control border-info">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label mt-2 fw-bold">End Serial</label>
                      <input type="number" [(ngModel)]="serialRange.end" name="serial_end" class="form-control border-info">
                    </div>
                  </div>

                  <div class="row g-3 mt-3">
                    <div class="col-md-2">
                      <label class="form-label mt-2 fw-bold">Make</label>
                      <select class="form-select" [(ngModel)]="serialRange.make" name="range_make">
                        <option *ngFor="let option of makes" [value]="option">{{ option }}</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label mt-2 fw-bold">Capacity</label>
                      <select class="form-select" [(ngModel)]="serialRange.capacity" name="range_capacity">
                        <option *ngFor="let option of capacities" [value]="option">{{ option }}</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label mt-2 fw-bold">Phase</label>
                      <select class="form-select" [(ngModel)]="serialRange.phase" name="range_phase">
                        <option *ngFor="let option of phases" [value]="option">{{ option }}</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label mt-2 fw-bold">Conn. Type</label>
                      <select class="form-select" [(ngModel)]="serialRange.connection_type" name="range_conn_type">
                        <option value="HT">HT</option>
                        <option value="LT">LT</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label mt-2 fw-bold">Category</label>
                      <select class="form-select" [(ngModel)]="serialRange.meter_category" name="range_category">
                        <option *ngFor="let option of meter_categories" [value]="option">{{ option }}</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <label class="form-label mt-2 fw-bold">Meter Type</label>
                      <select class="form-select" [(ngModel)]="serialRange.meter_type" name="range_type">
                        <option *ngFor="let option of meterTypes" [value]="option">{{ option }}</option>
                      </select>
                    </div>
                  </div>

                  <div class="row mt-3">
                    <div class="col-md-3 offset-md-9">
                      <button type="button" class="btn btn-outline-primary w-100" (click)="addSerialRange()">âž• Add Range</button>
                    </div>
                  </div>
                </div>
              </div>
            </div> <!-- /tab-content -->
          </div> <!-- /container-fluid -->

          <hr class="my-4">

          <!-- Meter Manual Entry Table -->
          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <thead class="table-light text-center">
                <tr>
                  <th>#</th>
                  <th>Serial No</th>
                  <th>Make</th>
                  <th>Capacity</th>
                  <th>Phase</th>
                  <th>Conn. Type</th>
                  <th>Category</th>
                  <th>Meter Type</th>
                  <th>Remark</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let device of devices; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td><input type="text" [(ngModel)]="device.serial_number" name="serial{{i}}" class="form-control" required></td>
                  <td>
                    <select class="form-select" [(ngModel)]="device.make" name="make{{i}}">
                      <option *ngFor="let option of makes" [value]="option">{{ option }}</option>
                    </select>
                  </td>
                  <td>
                    <select class="form-select" [(ngModel)]="device.capacity" name="capacity{{i}}">
                      <option *ngFor="let option of capacities" [value]="option">{{ option }}</option>
                    </select>
                  </td>
                  <td>
                    <select class="form-select" [(ngModel)]="device.phase" name="phase{{i}}">
                      <option *ngFor="let option of phases" [value]="option">{{ option }}</option>
                    </select>
                  </td>
                  <td>
                    <select class="form-select" [(ngModel)]="device.connection_type" name="connType{{i}}">
                      <option value="">--</option>
                      <option value="HT">HT</option>
                      <option value="LT">LT</option>
                    </select>
                  </td>
                  <td><input type="text" [(ngModel)]="device.meter_category" name="category{{i}}" class="form-control"></td>
                  <td><input type="text" [(ngModel)]="device.meter_type" name="type{{i}}" class="form-control"></td>
                  <td><input type="text" [(ngModel)]="device.remark" name="remark{{i}}" class="form-control"></td>
                  <td class="text-center">
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeDevice(i)">Ã—</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button type="button" class="btn btn-outline-success my-3" (click)="addDevice()">+ Add Device</button>
          <button type="button" class="btn btn-primary float-end" [disabled]="!devices.length" (click)="submitDevices()">Add Devices</button>
        </div>

        <!-- CT TAB -->
  <!-- CT TAB -->
<div class="tab-pane m-3 border fade" id="ct" role="tabpanel" aria-labelledby="ct-tab">
  <h4 class="card-title p-2 bg-dark text-white fw-bold text-primary rounded shadow border">Add Bulk CTs</h4>

  <!-- CT Defaults (apply to CSV / Range / New rows) -->
  <div class="bg-light p-3 rounded border mb-3">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label mt-2 fw-bold">CT Make</label>
        <select class="form-select" [(ngModel)]="ctMeta.make" name="ct_default_make" required>
          <option *ngFor="let option of makes" [value]="option">{{ option }}</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label mt-2 fw-bold">Capacity</label>
        <select class="form-select" [(ngModel)]="ctMeta.capacity" name="ct_default_capacity" required>
          <option *ngFor="let option of capacities" [value]="option">{{ option }}</option>
        </select>
        <small class="text-muted">Tip: choose <strong>CT OPERATED</strong> for CT devices.</small>
      </div>
      <div class="col-md-3">
        <label class="form-label mt-2 fw-bold">Phase</label>
        <select class="form-select" [(ngModel)]="ctMeta.phase" name="ct_default_phase" required>
          <option *ngFor="let option of phases" [value]="option">{{ option }}</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label mt-2 fw-bold">Category</label>
        <select class="form-select" [(ngModel)]="ctMeta.meter_category" name="ct_default_category" required>
          <option *ngFor="let option of meter_categories" [value]="option">{{ option }}</option>
        </select>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-3">
        <label class="form-label mt-2 fw-bold">Meter Type</label>
        <select class="form-select" [(ngModel)]="ctMeta.meter_type" name="ct_default_meter_type" required>
          <option *ngFor="let option of meterTypes" [value]="option">{{ option }}</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label mt-2 fw-bold">Connection Type</label>
        <select class="form-select" [(ngModel)]="ctMeta.connection_type" name="ct_default_connection_type" required>
          <option *ngFor="let option of connection_types" [value]="option">{{ option }}</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label mt-2 fw-bold">Voltage Rating</label>
        <select class="form-select" [(ngModel)]="ctMeta.voltage_rating" name="ct_default_voltage_rating" required>
          <option *ngFor="let option of voltage_ratings" [value]="option">{{ option }}</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label mt-2 fw-bold">Current Rating</label>
        <select class="form-select" [(ngModel)]="ctMeta.current_rating" name="ct_default_current_rating" required>
          <option *ngFor="let option of current_ratings" [value]="option">{{ option }}</option>
        </select>
      </div>
    </div>
  </div>

  <!-- CT entry tabs -->
  <ul class="nav nav-tabs custom-tabs mb-3 mt-4" id="ctEntryTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="ct-csv-tab" data-bs-toggle="tab" data-bs-target="#ct-csv" type="button" role="tab">ðŸ“„ Upload CSV</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="ct-range-tab" data-bs-toggle="tab" data-bs-target="#ct-range" type="button" role="tab">ðŸ”¢ Serial No Range</button>
    </li>
  </ul>

  <div class="tab-content" id="ctEntryTabContent">
    <!-- CT CSV Upload -->
    <div class="tab-pane fade show active" id="ct-csv" role="tabpanel">
      <div class="p-4 bg-white rounded shadow-sm border">
        <h6 class="mb-3 text-primary fw-bold">Upload CT List (CSV)</h6>
        <p class="text-muted mb-2">
          Header supported:<br>
          <code>serial_number, ct_class, ct_ratio, make, capacity, phase, meter_category, meter_type, connection_type, voltage_rating, current_rating, remark</code><br>
          Missing columns will use the defaults set above.
        </p>
        <input type="file" accept=".csv" (change)="handleCTCSVUpload($event)" class="form-control border-info">
      </div>
    </div>

    <!-- CT Serial No Range -->
    <div class="tab-pane fade" id="ct-range" role="tabpanel">
      <div class="p-4 bg-white rounded shadow-sm border">
        <h6 class="mb-3 text-primary fw-bold">Add CTs by Serial Number Range</h6>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label mt-2 fw-bold">Start Serial</label>
            <input type="number" [(ngModel)]="ctRange.start" name="ct_start" class="form-control border-info">
          </div>
          <div class="col-md-3">
            <label class="form-label mt-2 fw-bold">End Serial</label>
            <input type="number" [(ngModel)]="ctRange.end" name="ct_end" class="form-control border-info">
          </div>
          <div class="col-md-3">
            <label class="form-label mt-2 fw-bold">CT Class</label>
            <select class="form-select" [(ngModel)]="ctRange.ct_class" name="ct_class">
              <option value="">--</option>
              <option *ngFor="let option of ct_classes" [value]="option">{{ option }}</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label mt-2 fw-bold">CT Ratio</label>
            <select class="form-select" [(ngModel)]="ctRange.ct_ratio" name="ct_ratio">
              <option value="">--</option>
              <option *ngFor="let option of ct_ratios" [value]="option">{{ option }}</option>
            </select>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-3 offset-md-9">
            <button type="button" class="btn btn-outline-primary w-100" (click)="addCTSerialRange()">âž• Add Range</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr class="my-4">

  <!-- CT Manual Table -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light text-center">
        <tr>
          <th>#</th>
          <th>Serial No</th>
          <th>CT Class</th>
          <th>CT Ratio</th>
          <th>Make</th>
          <th>Capacity</th>
          <th>Phase</th>
          <th>Category</th>
          <th>Meter Type</th>
          <th>Conn. Type</th>
          <th>Voltage</th>
          <th>Current</th>
          <th>Remark</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ct of cts; let i = index">
          <td>{{ i + 1 }}</td>
          <td><input type="text" [(ngModel)]="ct.serial_number" name="ct_serial{{i}}" class="form-control" required></td>

          <td>
            <select class="form-select" [(ngModel)]="ct.ct_class" name="ct_class{{i}}">
              <option value="">--</option>
              <option *ngFor="let option of ct_classes" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.ct_ratio" name="ct_ratio{{i}}">
              <option value="">--</option>
              <option *ngFor="let option of ct_ratios" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.make" name="ct_make{{i}}">
              <option *ngFor="let option of makes" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.capacity" name="ct_capacity{{i}}">
              <option *ngFor="let option of capacities" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.phase" name="ct_phase{{i}}">
              <option *ngFor="let option of phases" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.meter_category" name="ct_category{{i}}">
              <option *ngFor="let option of meter_categories" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.meter_type" name="ct_meter_type{{i}}">
              <option *ngFor="let option of meterTypes" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.connection_type" name="ct_connection_type{{i}}">
              <option *ngFor="let option of connection_types" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.voltage_rating" name="ct_voltage{{i}}">
              <option *ngFor="let option of voltage_ratings" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td>
            <select class="form-select" [(ngModel)]="ct.current_rating" name="ct_current{{i}}">
              <option *ngFor="let option of current_ratings" [value]="option">{{ option }}</option>
            </select>
          </td>

          <td><input type="text" [(ngModel)]="ct.remark" name="ct_remark{{i}}" class="form-control"></td>

          <td class="text-center">
            <button type="button" class="btn btn-sm btn-danger" (click)="removeCT(i)">Ã—</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <button type="button" class="btn btn-outline-success my-3" (click)="addCT()">+ Add CT</button>
  <button type="button" class="btn btn-primary float-end" [disabled]="!cts.length" (click)="submitCTs()">Add CTs</button>
</div>

      </div>
    </div>
  </div>
</div>

<!-- Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">{{ alertTitle }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">{{ alertMessage }}</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
