<div class="container-fluid py-4">
  <div class="card shadow-sm">
    <div class="card-header text-white" style="background: rgb(71, 175, 124); color:#fff;">
      <h5 class="mb-0">RMTL ‚Äî Add Bulk Devices and CTs</h5>
    </div>

    <div class="card-body p-4">
      <!-- SOURCE -->
      <form #sourceForm="ngForm" class="mb-4">
        <div class="rounded-4 border p-3 p-md-4 bg-light-subtle">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <div class="form-floating">
                <select class="form-select" [(ngModel)]="selectedSourceType" name="source_type"
                        (change)="onSourceTypeChange()" required>
                  <option [ngValue]="''" disabled>Select...</option>
                  <option *ngFor="let type of office_types" [value]="type">{{ type }}</option>
                </select>
                <label class="fw-semibold">Source Type</label>
              </div>
            </div>

            <div class="col-md-5">
              <div class="input-group input-group-lg">
                <!-- <span class="input-group-text"><i class="bi bi-geo-alt"></i></span> -->
                <div class="form-floating flex-grow-1">
                  <input type="text" class="form-control" [(ngModel)]="selectedSourceName"
                         name="source_name" placeholder="Code" required (keydown.enter)="fetchButtonData()">
                  <label class="fw-semibold">Location / Store / Vendor Code</label>
                </div>
              </div>
            </div>

            <div class="col-md-3 d-grid">
              <button type="button" class="btn btn-primary py-3" (click)="fetchButtonData()">
                <i class="bi bi-search"></i> Fetch
              </button>
            </div>
          </div>

          <!-- SOURCE DETAILS -->
          <div class="table-responsive mt-3" *ngIf="filteredSources">
            <table class="table table-sm table-striped table-bordered align-middle mb-0">
              <thead class="table-light sticky-top">
                <tr class="text-nowrap">
                  <th>Name</th><th>Division Name</th><th>Code</th><th>Circle Name</th><th>Region Name</th>
                  <th>Org Name</th><th>Division Code</th><th>Circle Code</th><th>Region Code</th><th>Org Code</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>{{ filteredSources?.name }}</td>
                  <td>{{ filteredSources?.division_name }}</td>
                  <td><span class="badge text-bg-dark">{{ filteredSources?.code }}</span></td>
                  <td>{{ filteredSources?.circle_name }}</td>
                  <td>{{ filteredSources?.region_name }}</td>
                  <td>{{ filteredSources?.org_name }}</td>
                  <td>{{ filteredSources?.division_code }}</td>
                  <td>{{ filteredSources?.circle_code }}</td>
                  <td>{{ filteredSources?.region_code }}</td>
                  <td>{{ filteredSources?.org_code }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </form>

      <!-- MAIN TABS -->
      <ul class="nav nav-tabs custom-tabs flex-nowrap overflow-auto" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="meter-tab" data-bs-toggle="tab" data-bs-target="#meter"
                  type="button" role="tab">
            <i class="bi bi-speedometer2"></i> METERS
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ct-tab" data-bs-toggle="tab" data-bs-target="#ct" type="button" role="tab">
            <i class="bi bi-cpu"></i> CTs
          </button>
        </li>
      </ul>

      <div class="tab-content mt-3" id="myTabContent">
        <!-- METERS -->
        <div class="tab-pane m-3 border rounded-4 fade show active p-3 p-md-4" id="meter" role="tabpanel">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0 fw-bold text-primary">
              <i class="bi bi-plus-square-dotted"></i> Add Bulk Meters
            </h5>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" type="button" (click)="downloadMeterCSVTemplate()">
                <i class="bi bi-filetype-csv"></i> CSV Template
              </button>
              <button class="btn btn-outline-secondary btn-sm" type="button" (click)="clearMeters()"
                      [disabled]="!devices || !devices.length">
                <i class="bi bi-trash3"></i> Clear
              </button>
            </div>
          </div>

          <!-- Defaults strip -->
          <div class="bg-body-tertiary rounded-4 border p-3">
            <div class="row g-3">
              <!-- <div class="col-md-3" *ngFor="let def of meterDefaultsUI">
                <div class="form-floating">
                  <select class="form-select" [(ngModel)]="serialRange[def.key]" name="def_{{def.key}}">
                    <option *ngFor="let option of def.options" [value]="option">{{ option }}</option>
                  </select>
                  <label class="fw-semibold">{{ def.label }}</label>
                </div>
              </div> -->
                       <div class="col-md-3" *ngFor="let def of meterDefaultsUI">
  <div class="form-floating">
    <!-- Dynamic Phase options tied to current defaults' connection type -->
    <select *ngIf="def.key === 'phase'; else normalDefaultSelect"
            class="form-select"
            [(ngModel)]="serialRange.phase"
            name="def_phase">
      <option *ngFor="let option of getPhaseOptions(serialRange.connection_type)" [value]="option">
        {{ option }}
      </option>
    </select>

    <ng-template #normalDefaultSelect>
      <select class="form-select"
              [(ngModel)]="serialRange[def.key]"
              name="def_{{def.key}}"
              (ngModelChange)="def.key === 'connection_type' ? onDefaultsConnectionTypeChange() : null">
        <option *ngFor="let option of def.options" [value]="option">{{ option }}</option>
      </select>
    </ng-template>

    <label class="fw-semibold">{{ def.label }}</label>
  </div>
</div>
            </div>
          </div>
 


          <!-- Sub tabs -->
          <ul class="nav nav-tabs custom-tabs flex-nowrap overflow-auto mb-3 mt-3" id="entryTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv" type="button" role="tab">
                üìÑ Upload CSV
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="range-tab" data-bs-toggle="tab" data-bs-target="#range" type="button" role="tab">
                üî¢ Serial No Range
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                ‚úçÔ∏è Manual
              </button>
            </li>
          </ul>

          <div class="tab-content" id="entryTabContent">
            <!-- CSV -->
            <div class="tab-pane fade show active" id="csv" role="tabpanel" aria-labelledby="csv-tab">
              <div class="p-4 bg-white rounded-4 shadow-sm border-dashed">
                <h6 class="mb-2 text-primary fw-bold">Upload Device List (CSV)</h6>
                <p class="text-muted small mb-3">
                  Header: <code>serial_number</code>
                </p>
                <div class="d-flex flex-column flex-md-row align-items-center gap-2">
                  <input type="file" accept=".csv" (change)="handleCSVUpload($event)" class="form-control">
                  
                </div>
              </div>
            </div>

            <!-- Range -->
            <div class="tab-pane fade" id="range" role="tabpanel" aria-labelledby="range-tab">
              <div class="p-4 bg-white rounded-4 shadow-sm border">
                <h6 class="mb-3 text-primary fw-bold">Add Devices by Serial Number Range</h6>
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" [(ngModel)]="serialRange.start" name="serial_start" class="form-control" placeholder="Start">
                      <label>Start Serial</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" [(ngModel)]="serialRange.end" name="serial_end" class="form-control" placeholder="End">
                      <label>End Serial</label>
                    </div>
                  </div>
                  <div class="col-md-4 d-grid">
                    <button type="button" class="btn btn-outline-primary h-100" (click)="addSerialRange()">
                      ‚ûï Add Range 
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Manual quick add -->
            <div class="tab-pane fade" id="manual" role="tabpanel" aria-labelledby="manual-tab">
              <div class="p-4 bg-white rounded-4 shadow-sm border">
                <div class="row g-3">
                  <div class="col-md-6">
                    <div appBarcodeListener (barcodeScanned)="onScan($any($event))">                      
                       <div class="form-floating">
                      <input type="text" class="form-control" [(ngModel)]="quick.serial" name="quick_serial" placeholder="Scan or Enter Meter Serial" (keyup.enter)="quickAddMeter()">
                      <label for="quick_serial"> Scan or Enter Meter Serial</label>
                    </div>
                    </div>
                  </div>
                  <div class="col-md-6 d-grid">
                    <button class="btn btn-outline-success" type="button" (click)="quickAddMeter()">
                      <i class="bi bi-plus-circle"></i> Quick Add Meter 
                    </button>
                  </div>
                </div>
                <small class="text-muted d-block mt-2 text-primary">Uses current defaults above for other fields.</small>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <!-- METER TABLE -->
          <div class="table-responsive rounded-4 border overflow-auto" style="max-height: 52vh;">
            <table class="table table-sm table-hover align-middle mb-0 table-modern">
              <thead class="table-light position-sticky top-0">
                <tr class="text-center text-nowrap">
                  <th>#</th><th>Serial No</th><th>Make</th><th>Capacity</th><th>Phase</th><th>Conn.</th>
                  <th>Category</th><th>Meter Type</th><th>Voltage</th><th>Current</th><th>Purpose</th><th>Remark</th><th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let device of devices; let i = index" [class.table-warning]="isDuplicateSerial(device.serial_number, 'METER')">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>
                    <input type="text" [(ngModel)]="device.serial_number" name="serial{{i}}"
                           class="form-control form-control-sm" required
                           [class.is-invalid]="!device.serial_number">
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.make" name="make{{i}}">
                      <option *ngFor="let option of makes" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.capacity" name="capacity{{i}}">
                      <option *ngFor="let option of capacities" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.phase" name="phase{{i}}">
                      <option *ngFor="let option of phases" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.connection_type" name="connType{{i}}">
                      <option *ngFor="let option of connection_types" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.meter_category" name="category{{i}}">
                      <option *ngFor="let option of meter_categories" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.meter_type" name="type{{i}}">
                      <option *ngFor="let option of meterTypes" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.voltage_rating" name="voltage{{i}}">
                      <option *ngFor="let option of voltage_ratings" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.current_rating" name="current{{i}}">
                      <option *ngFor="let option of current_ratings" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="device.device_testing_purpose" name="purpose{{i}}" required>
                      <option *ngFor="let p of device_testing_purpose" [value]="p">{{ p }}</option>
                    </select>
                  </td>

                  <td><input type="text" [(ngModel)]="device.remark" name="remark{{i}}" class="form-control form-control-sm"></td>

                  <td class="text-center">
                    <button type="button" class="btn btn-icon btn-sm btn-outline-danger" (click)="removeDevice(i)"> ‚úï </button>
                  </td>
                </tr>
                <tr *ngIf="!devices?.length">
                  <td colspan="13" class="text-center text-muted py-4">
                    No meter rows yet. Upload CSV, add a range, or use Quick Add.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Sticky actions -->
          <div class="action-bar d-flex align-items-center gap-2 mt-3">
            <button type="button" class="btn btn-outline-success" (click)="addDevice()">
              + Add New Row
            </button>
            <div class="ms-auto">
              <button type="button" class="btn btn-primary" [disabled]="!devices.length" (click)="submitDevices()">
                <i class="bi bi-cloud-upload"></i> Validate & Submit 
              </button>
            </div>
          </div>
        </div>

        <!-- CTs -->
        <div class="tab-pane m-3 border rounded-4 fade p-3 p-md-4" id="ct" role="tabpanel">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0 fw-bold text-primary">
              <i class="bi bi-plus-square-dotted"></i> Add Bulk CTs
            </h5>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" type="button" (click)="downloadCTCSVTemplate()">
                <i class="bi bi-filetype-csv"></i> CSV Template
              </button>
              <button class="btn btn-outline-secondary btn-sm" type="button" (click)="clearCTs()" [disabled]="cts.length === 0">
                <i class="bi bi-trash3"></i> Clear
              </button>
              
            </div>
          </div>

          <!-- CT defaults -->
          <div class="bg-body-tertiary rounded-4 border p-3 mb-3">
            <div class="row g-3">
              <div class="col-md-3" *ngFor="let def of ctDefaultsUI">
                <div class="form-floating">
                  <select class="form-select" [(ngModel)]="ctMeta[def.key]" name="ct_default_{{def.key}}">
                    <option *ngFor="let option of def.options" [value]="option">{{ option }}</option>
                  </select>
                  <label class="fw-semibold">{{ def.label }}</label>
                </div>
              </div>
            </div>
          </div>

          <!-- CT Entry tabs -->
          <ul class="nav nav-tabs custom-tabs flex-nowrap overflow-auto mb-3 mt-2" id="ctEntryTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="ct-csv-tab" data-bs-toggle="tab" data-bs-target="#ct-csv" type="button" role="tab">üìÑ Upload CSV</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="ct-range-tab" data-bs-toggle="tab" data-bs-target="#ct-range" type="button" role="tab">üî¢ Serial No Range</button>
            </li>
           <li class="nav-item" role="presentation">
            <button class="nav-link" id="ct-manual-tab" data-bs-toggle="tab" data-bs-target="#ct-manual" type="button" role="tab">
              ‚úçÔ∏è Manual
            </button>
          </li>

          </ul>

          <div class="tab-content" id="ctEntryTabContent">
            <div class="tab-pane fade show active" id="ct-csv" role="tabpanel">
              <div class="p-4 bg-white rounded-4 shadow-sm border">
                <h6 class="mb-2 text-primary fw-bold">Upload CT List (CSV)</h6>
                <p class="text-muted small mb-3">
                  Header: <code>serial_number</code>
                </p>
                <input type="file" accept=".csv" (change)="handleCTCSVUpload($event)" class="form-control">
              </div>
            </div>

            <div class="tab-pane fade" id="ct-range" role="tabpanel">
              <div class="p-4 bg-white rounded-4 shadow-sm border">
                <h6 class="mb-3 text-primary fw-bold">Add CTs by Serial Number Range</h6>
                <div class="row g-3">
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" [(ngModel)]="ctRange.start" name="ct_start" class="form-control" placeholder="Start">
                      <label>Start Serial</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-floating">
                      <input type="number" [(ngModel)]="ctRange.end" name="ct_end" class="form-control" placeholder="End">
                      <label>End Serial</label>
                    </div>
                  </div>
                  <div class="col-md-4 d-grid">
                    <button type="button" class="btn btn-outline-primary h-100" (click)="addCTSerialRange()">‚ûï Add Range</button>
                  </div>
                </div>
              </div>
            </div>
            <!-- Add this new pane inside #ctEntryTabContent -->
<div class="tab-pane fade" id="ct-manual" role="tabpanel" aria-labelledby="ct-manual-tab">
  <div class="p-4 bg-white rounded-4 shadow-sm border">
    <h6 class="mb-3 text-primary fw-bold">Quick Add CT</h6>
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        
                    <div appBarcodeListener (barcodeScanned)="onScan($any($event))">
        <div class="form-floating">

          <input type="text" class="form-control" [(ngModel)]="ctQuick.serial" name="ct_quick_serial" placeholder="Serial" (keyup.enter)="quickAddCT()">
          <label>CT Serial Number</label>
        </div>
                    </div>
      </div>
      <div class="col-md-6 d-grid">
        <button class="btn btn-outline-success py-3" type="button" (click)="quickAddCT()">
          <i class="bi bi-plus-circle"></i> Quick Add CT
        </button>
      </div>
    </div>
    <small class="text-muted d-block mt-2">Uses current CT defaults (make, connection type, purpose, initiator, etc.).</small>
  </div>
</div>

          </div>

          <hr class="my-4">
          <!-- CT TABLE (fixed one stray <td>) -->
          <div class="table-responsive rounded-4 border overflow-auto" style="max-height: 52vh;">
            <table class="table table-sm table-hover align-middle mb-0 table-modern">
              <thead class="table-light position-sticky top-0">
                <tr class="text-center text-nowrap">
                  <th>S.No</th><th>Serial No</th><th>CT Class</th><th>CT Ratio</th><th>Make</th>
                  <th>Conn. Type</th><th>Purpose</th><th>Remark</th><th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let ct of cts; let i = index" [class.table-warning]="isDuplicateSerial(ct.serial_number, 'CT')">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td><input type="text" [(ngModel)]="ct.serial_number" name="ct_serial{{i}}" class="form-control form-control-sm" required></td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="ct.ct_class" name="ct_class{{i}}">
                      <option value="">--</option>
                      <option *ngFor="let option of ct_classes" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="ct.ct_ratio" name="ct_ratio{{i}}">
                      <option value="">--</option>
                      <option *ngFor="let option of ct_ratios" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="ct.make" name="ct_make{{i}}">
                      <option *ngFor="let option of makes" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="ct.connection_type" name="ct_connection_type{{i}}">
                      <option *ngFor="let option of connection_types" [value]="option">{{ option }}</option>
                    </select>
                  </td>

                  <td>
                    <select class="form-select form-select-sm" [(ngModel)]="ct.device_testing_purpose" name="ct_purpose{{i}}" required>
                      <option *ngFor="let p of device_testing_purpose" [value]="p">{{ p }}</option>
                    </select>
                  </td>

                  <td><input type="text" [(ngModel)]="ct.remark" name="ct_remark{{i}}" class="form-control form-control-sm"></td>

                  <td class="text-center">
                    <button type="button" class="btn btn-icon btn-sm btn-outline-danger" (click)="removeCT(i)">‚úï </button>
                  </td>
                </tr>
                <tr *ngIf="!cts?.length">
                  <td colspan="15" class="text-center text-muted py-4">No CT rows yet. Upload CSV or add a range.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="action-bar d-flex align-items-center gap-2 mt-3">
            <button type="button" class="btn btn-outline-success" (click)="addCT()">+ Add New Row</button>
            <div class="ms-auto">
              <button type="button" class="btn btn-primary" [disabled]="!cts.length" (click)="submitCTs()">
                <i class="bi bi-cloud-upload"></i> Validate & Submit
              </button>
            </div>
          </div>
        </div>
      </div> <!-- /tab-content -->
    </div>
  </div>
</div>

<!-- Alert Modal (kept) -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header  text-white rounded-top-4" style="background: rgb(71, 175, 124); color:#fff;">
        <h5 class="modal-title">{{ alertTitle }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">{{ alertMessage }}</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>