<div class="container-fluid mt-4">
  <div class="card shadow border-0">
    <div class="card-header text-white d-flex flex-wrap justify-content-between align-items-center" style="background:#151433">
      <h5 class="mb-0">RMTL — Pending Tested Devices for Approval</h5>
      <div class="d-flex flex-wrap align-items-center gap-2 mt-2 mt-md-0">
        <span class="badge bg-secondary">
          From: {{ fromDate ? (fromDate) : '—' }}
        </span>
        <span class="badge bg-secondary">
          To: {{ toDate ? (toDate) : '—' }}
        </span>
        <span class="badge bg-info">Total: {{ filtered.length }}</span>
        <span class="badge bg-success">Selected: {{ selectedCount }}</span>
      </div>
    </div>

    <div class="card-body">

      <!-- Date range filters ONLY -->
      <div class="row g-3 align-items-end">
        <div class="col-sm-6 col-md-3">
          <label class="form-label fw-semibold">From Date</label>
          <input type="date" class="form-control" [(ngModel)]="fromDate" name="fromDate" (change)="onDatesChange()">
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label fw-semibold">To Date</label>
          <input type="date" class="form-control" [(ngModel)]="toDate" name="toDate" (change)="onDatesChange()">
        </div>
      </div>

      <!-- Loading / error -->
      <div class="mt-3" *ngIf="loading">
        <div class="alert alert-info d-flex align-items-center gap-2 mb-0">
          <span class="spinner-border spinner-border-sm"></span>
          <span>Loading...</span>
        </div>
      </div>
      <div class="mt-3" *ngIf="!loading && errorMsg">
        <div class="alert alert-danger mb-0">{{ errorMsg }}</div>
      </div>

      <!-- Table -->
      <div class="table-responsive border rounded mt-3" *ngIf="!loading && filtered.length">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
            <tr class="text-nowrap">
              <th style="width:58px;">Pick</th>
              <th>Device</th>
              <th>Serial</th>
              <th>Make</th>
              <th>Type/Category</th>
              <th>Capacity</th>
              <th>Voltage</th>
              <th>Inward Date</th>
              <th class="d-none d-lg-table-cell">Location</th>
              <th style="width:180px;">Action</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let r of pageRows; trackBy: trackById">
<td class="text-center">
  <input
    type="checkbox"
    class="form-check-input"
    [ngModel]="r.selected"
    (ngModelChange)="r.selected=$event; onRowCheckboxChange()"
    [ngModelOptions]="{standalone:true}"
    [attr.name]="'pick_'+(r.device_id || r.id)"
    [disabled]="!r.canApprove"
    [title]="r.canApprove ? 'Select' : 'Not eligible for approval'">
</td>


              <td class="fw-semibold">{{ r.device_id || r.id }}</td>
              <td>{{ r.serial_number || '-' }}</td>
              <td>{{ r.make || '-' }}</td>

              <td>
                <span class="d-inline-block text-truncate" style="max-width: 160px;"
                      [title]="(r.meter_type || '-') + (r.meter_category ? ' / ' + r.meter_category : '')">
                  {{ r.meter_type || '-' }}<ng-container *ngIf="r.meter_category"> / {{ r.meter_category }}</ng-container>
                </span>
              </td>

              <td>{{ r.capacity || '-' }}</td>
              <td>{{ r.voltage_rating || '-' }}</td>

              <td>
                <span [title]="r.inward_date">
                  {{ r.inward_date }}
                </span>
              </td>

              <td class="d-none d-lg-table-cell">
                <span class="d-inline-block text-truncate" style="max-width: 180px;" [title]="r.location_name">
                  {{ r.location_name || '-' }}
                </span>
              </td>

              <td>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" type="button"
                          (click)="openDetails(r)" data-bs-toggle="offcanvas" data-bs-target="#detailsCanvas">
                    Details
                  </button>
                  <button class="btn btn-success" type="button"
                          (click)="openApproveModal(r)" [disabled]="!r.canApprove">
                    Approve
                  </button>
                </div>
              </td>
            </tr>
          </tbody>

        </table>
      </div>

      <!-- Empty state -->
      <div class="mt-4" *ngIf="!loading && !filtered.length && !errorMsg">
        <div class="alert alert-warning mb-0">
          No devices found in the selected range.
        </div>
      </div>

      <!-- Pagination + select all (page) & Approve Selected -->
      <div class="d-flex justify-content-between align-items-center mt-3" *ngIf="!loading && filtered.length">
        <div class="d-flex align-items-center gap-3">
          <div class="form-check">
            <input id="selectAll" type="checkbox" class="form-check-input" [(ngModel)]="selectAll" name="selectAll" (change)="toggleAllOnPage()">
            <label class="form-check-label" for="selectAll">Select All (current page)</label>
          </div>
          <button class="btn btn-success btn-sm" type="button" (click)="openApproveModal()" [disabled]="selectedCount === 0">
            Approve Selected
          </button>
        </div>

        <nav>
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item" [class.disabled]="page===1">
              <a class="page-link" href="javascript:void(0)" (click)="goto(page-1)">Prev</a>
            </li>
            <li class="page-item" *ngFor="let p of pages" [class.active]="p===page">
              <a class="page-link" href="javascript:void(0)" (click)="goto(p)">{{ p }}</a>
            </li>
            <li class="page-item" [class.disabled]="page===pages[pages.length-1]">
              <a class="page-link" href="javascript:void(0)" (click)="goto(page+1)">Next</a>
            </li>
          </ul>
        </nav>
      </div>

    </div>
  </div>
</div>

<!-- Offcanvas: Details -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="detailsCanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Device Details</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body" *ngIf="selectedRow">
    <div class="small text-muted mb-2">Device: {{ selectedRow?.device_id || selectedRow?.id }}</div>

    <div class="row g-2">
      <div class="col-6"><strong>Serial:</strong> {{ selectedRow?.serial_number || '-' }}</div>
      <div class="col-6"><strong>Make:</strong> {{ selectedRow?.make || '-' }}</div>
      <div class="col-6"><strong>Type:</strong> {{ selectedRow?.meter_type || '-' }}</div>
      <div class="col-6"><strong>Category:</strong> {{ selectedRow?.meter_category || '-' }}</div>
      <div class="col-6"><strong>Capacity:</strong> {{ selectedRow?.capacity || '-' }}</div>
      <div class="col-6"><strong>Voltage:</strong> {{ selectedRow?.voltage_rating || '-' }}</div>
      <div class="col-6"><strong>Class:</strong> {{ selectedRow?.meter_class || '-' }}</div>
      <div class="col-6"><strong>Phase:</strong> {{ selectedRow?.phase || '-' }}</div>
    </div>

    <hr>

    <div class="row g-2">
      <div class="col-6"><strong>Status:</strong> {{ selectedRow?.test_status || selectedRow?.device_status || '-' }}</div>
      <div class="col-6"><strong>Result:</strong> {{ selectedRow?.test_result || '-' }}</div>
      <div class="col-6"><strong>Tested/Inward:</strong> {{ (selectedRow?.tested_date || selectedRow?.inward_date) }}</div>
      <div class="col-6"><strong>Initiator:</strong> {{ selectedRow?.initiator || '-' }}</div>
      <div class="col-6"><strong>Office:</strong> {{ selectedRow?.office_type || '-' }}</div>
      <div class="col-6"><strong>Location:</strong> {{ selectedRow?.location_name || '-' }}</div>
      <div class="col-12"><strong>Purpose:</strong> {{ selectedRow?.device_testing_purpose || '-' }}</div>
    </div>

    <hr>
    <!-- <div><strong>Other:</strong> {{ selectedRow?.other || '-' }}</div> -->
    <div class="text-muted small mt-2"><strong>Details:</strong> {{ selectedRow?.details || '-' }}</div>

    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-success btn-sm"
              (click)="openApproveModal(selectedRow)"
              [disabled]="!selectedRow?.canApprove">Approve</button>
    </div>
  </div>
</div>

<!-- Modal: Approve confirm -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Approval</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" [disabled]="approving"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          You’re about to approve <strong>{{ selectedCount }}</strong> eligible device(s).
          <br><span class="text-muted small">Rows not eligible will be ignored automatically.</span>
        </p>
        <div class="mb-2">
          <label class="form-label">Note (optional)</label>
          <textarea class="form-control" [(ngModel)]="confirmApproveNote" [name]="'confirmApproveNote'" rows="2" placeholder="Approval note..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal" [disabled]="approving">Cancel</button>
        <button class="btn btn-success" (click)="submitApproval()" [disabled]="approving || selectedCount===0">
          <span *ngIf="approving" class="spinner-border spinner-border-sm me-1"></span>
          Approve
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Result -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Approval Result</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body" *ngIf="approveResult as r">
        <!-- Summary -->
        <div class="row g-3 align-items-center">
          <div class="col-6">
            <div class="d-flex align-items-center justify-content-between border rounded p-2">
              <div class="text-success fw-bold">Approved</div>
              <div class="badge bg-success">{{ r.ok }}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex align-items-center justify-content-between border rounded p-2">
              <div class="text-danger fw-bold">Failed</div>
              <div class="badge bg-danger">{{ r.failed }}</div>
            </div>
          </div>
        </div>

        <div class="small text-muted mt-2">
          Done at: {{ approvePerformedAt | date:'short' }}
        </div>

        <!-- Approved IDs -->
        <div *ngIf="approvedIds?.length" class="mt-3">
          <div class="fw-semibold mb-1">Approved IDs</div>
          <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-success" *ngFor="let id of approvedIds; trackBy: trackId">
              {{ id }}
            </span>
          </div>
        </div>

        <!-- Failed list -->
        <div *ngIf="failedList?.length" class="mt-3">
          <div class="fw-semibold mb-1">Failed Items</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width:140px;">ID</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let f of failedList">
                  <td><code>{{ f?.id }}</code></td>
                  <td>{{ f?.reason || 'Unknown error' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Raw details (optional debug) -->
        <details *ngIf="r.details" class="mt-3">
          <summary>Raw Details</summary>
          <pre class="mt-2 bg-light p-2 rounded small">{{ r.details | json }}</pre>
        </details>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
