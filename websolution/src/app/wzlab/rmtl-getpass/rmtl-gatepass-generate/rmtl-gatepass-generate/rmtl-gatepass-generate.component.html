<!-- rmtl-gatepass-generate.component.html -->
<div class="container-fluid mt-4">
  <div class="card shadow border-0">
    <div class="card-header text-white d-flex justify-content-between align-items-center" style="background:#151433">
      <h5 class="mb-0">RMTL — Gatepass Generate</h5>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="badge bg-secondary">From: {{ fromDate }}</span>
        <span class="badge bg-secondary">To: {{ toDate }}</span>
      </div>
    </div>

    <div class="card-body">
      <!-- Filters -->
      <div class="row g-3 align-items-end">
        <div class="col-sm-6 col-md-3">
          <label class="form-label fw-semibold">From Date</label>
          <input type="date" class="form-control" [(ngModel)]="fromDate" name="fromDate" (change)="onDatesChange()">
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label fw-semibold">To Date</label>
          <input type="date" class="form-control" [(ngModel)]="toDate" name="toDate" (change)="onDatesChange()">
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label fw-semibold">Select Report ID</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
            <select class="form-select" [(ngModel)]="selectedReportId" name="report_id" (change)="onReportChange()">
              <option value="" disabled selected>Choose...</option>
              <option *ngFor="let id of reportIds" [value]="id">{{ id }}</option>
            </select>
          </div>
        </div>
          <div class="col-sm-6 col-md-3">
            <!-- <label class="form-label fw-semibold">Select Inword No</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
              <select class="form-select" [(ngModel)]="selectedInwordNo" name="selectedInwordNo" (change)="onReportselectedInwordNoChange()">
                <option value="" disabled selected>Choose...</option>
                <option *ngFor="let inwordNo of inwordNos" [value]="inwordNo">{{ inwordNo }}</option>
              </select>
            </div> -->
          </div>
      </div>

      <!-- Loading / Errors -->
      <div class="mt-3" *ngIf="loadingList || loadingDevices">
        <div class="alert alert-info d-flex align-items-center gap-2 mb-0">
          <span class="spinner-border spinner-border-sm"></span>
          <span>Loading...</span>
        </div>
      </div>
      <div class="mt-3" *ngIf="!loadingList && !loadingDevices && errorMsg">
        <div class="alert alert-danger mb-0">{{ errorMsg }}</div>
      </div>

      <!-- Devices -->
      <div class="mt-4" *ngIf="!loadingDevices && devices.length">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
          <div class="form-check">
            <input id="selectAll" type="checkbox" class="form-check-input" [(ngModel)]="selectAll" (change)="toggleAllDevices()">
            <label class="form-check-label" for="selectAll">Select All</label>
          </div>
          <div class="small text-muted">
            Selected: <span class="fw-bold">{{ selectedCount }}</span> / {{ devices.length }}
          </div>
        </div>

        <div class="table-responsive border rounded">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light position-sticky top-0" style="z-index:1;">
              <tr class="text-nowrap">
                <th style="width:60px;">Pick</th>
                <th>Serial No</th>
                <th class="d-none d-sm-table-cell">Make</th>
                <th>Report ID</th>
                <th>Result</th>
                <th>Status</th>
                <th class="d-none d-md-table-cell">Method</th>
                <th class="d-none d-lg-table-cell">Start</th>
                <th class="d-none d-lg-table-cell">End</th>
                <th class="text-center" style="width: 90px;">Details</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let d of devices; trackBy: trackBySerial">
                <td class="text-center">
                  <input type="checkbox" [(ngModel)]="d.selected" (change)="onRowCheckboxChange()">
                </td>

                <td class="fw-semibold">{{ d.serial_number }}</td>
                <td class="d-none d-sm-table-cell">{{ d.make || '-' }}</td>
                <td><code class="small">{{ d.report_id }}</code></td>

                <td>
                  <span class="badge" [ngClass]="resultClass(d.test_result)">
                    {{ d.test_result || '-' }}
                  </span>
                </td>

                <td>
                  <span class="badge" [ngClass]="statusClass(d.test_status)">
                    {{ d.test_status || '-' }}
                  </span>
                </td>

                <td class="d-none d-md-table-cell">{{ d.test_method || '-' }}</td>
                <td class="d-none d-lg-table-cell">
                  <span [title]="d.start_datetime">{{ d.start_datetime | date:'short' }}</span>
                </td>
                <td class="d-none d-lg-table-cell">
                  <span [title]="d.end_datetime">{{ d.end_datetime | date:'short' }}</span>
                </td>

                <td class="text-center">
                  <button class="btn btn-sm btn-outline-primary" (click)="openDetailModal(d)">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
          <button class="btn btn-outline-secondary" type="button" (click)="clearSelection()">
            Clear Selection
          </button>
          <button class="btn btn-success" type="button" (click)="openGatepassModal()" [disabled]="selectedCount === 0">
            Generate Gatepass
          </button>
        </div>
      </div>

      <!-- Empty state -->
      <div class="mt-4" *ngIf="!loadingDevices && selectedReportId && devices.length === 0 && !errorMsg">
        <div class="alert alert-warning mb-0">
          No devices found for the selected report.
        </div>
      </div>

      <!-- Gatepass summary -->
      <div class="mt-4" *ngIf="gatepassInfo">
        <hr>
        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead class="table-light">
              <tr>
                <th colspan="4" class="text-primary">Gatepass Summary</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>Gatepass ID / Report IDs:</th>
                <td>{{ gatepassInfo.id }} / {{ gatepassInfo.report_ids }}</td>
                <th>Receiver Name:</th>
                <td>{{ gatepassInfo.receiver_name }}</td>
              </tr>
              <tr>
                <th>Receiver Mobile:</th>
                <td>{{ gatepassInfo.receiver_mobile }}</td>
                <th>Dispatch Number:</th>
                <td>{{ gatepassInfo.dispatch_number }}</td>
              </tr>
              <tr>
                <th>Dispatch To:</th>
                <td>{{ gatepassInfo.dispatch_to }}</td>
                <th>Vehicle:</th>
                <td>{{ gatepassInfo.vehicle }}</td>
              </tr>
              <tr>
                <th>Created By:</th>
                <td>{{ gatepassInfo.created_by }}</td>
                <th>Created At:</th>
                <td>{{ gatepassInfo.created_at }}</td>
              </tr>
              <tr>
                <th>List of Dispatch Serial Numbers:</th>
                <td colspan="3">{{ gatepassInfo.serial_numbers }}</td>
              </tr>
            </tbody>
          </table>
          <div class="mt-3">
            <button class="btn btn-outline-primary" (click)="printGatepass()">Download/Print Gatepass</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Gatepass Create Modal -->
<div class="modal fade" id="gatepassModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Gatepass</h5>
        <button type="button" class="btn-close" (click)="closeGatepassModal()"></button>
      </div>

      <div class="modal-body">
        <!-- ✅ no nested form tags -->
        <div class="row g-3">
          <!-- SOURCE -->
          <div class="rounded-4 border p-3 p-md-4 bg-light-subtle">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <div class="form-floating">
                  <select class="form-select" [(ngModel)]="selectedSourceType" name="source_type"
                          (change)="onSourceTypeChange()" required>
                    <option [ngValue]="''" disabled>Select...</option>
                    <option *ngFor="let type of office_types" [value]="type">{{ type }}</option>
                  </select>
                  <label class="fw-semibold">Source Type</label>
                </div>
              </div>
              <div class="col-md-5">
                <div class="input-group input-group-lg">
                  <div class="form-floating flex-grow-1">
                    <input type="text" class="form-control" [(ngModel)]="selectedSourceName"
                           name="source_name" placeholder="Code" required (keydown.enter)="fetchButtonData()">
                    <label class="fw-semibold">Location / Store / Vendor Code</label>
                  </div>
                </div>
              </div>
              <div class="col-md-3 d-grid">
                <button type="button" class="btn btn-primary py-3" (click)="fetchButtonData()">
                  <i class="bi bi-search"></i> Fetch
                </button>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Dispatch To</label>
            <input class="form-control" name="dispatch_to" [(ngModel)]="gatepassForm.dispatch_to" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Vehicle</label>
            <input class="form-control" name="vehicle" [(ngModel)]="gatepassForm.vehicle" required>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-semibold">Receiver Name</label>
            <input class="form-control" name="receiver_name" [(ngModel)]="gatepassForm.receiver_name" required>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Receiver Designation</label>
            <input class="form-control" name="receiver_designation" [(ngModel)]="gatepassForm.receiver_designation" required>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Receiver Mobile</label>
            <input class="form-control" name="receiver_mobile" [(ngModel)]="gatepassForm.receiver_mobile"
                   required pattern="^[0-9]{10}$" placeholder="10-digit mobile">
            <div class="form-text">Digits only, e.g. 9876543210</div>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Report ID(s)</label>
            <input class="form-control" name="report_ids" [(ngModel)]="gatepassForm.report_ids" readonly disabled>
          </div>

          <div class="col-12">
            <label class="form-label fw-semibold">Total Serial Numbers </label>
            <textarea class="form-control" name="serial_numbers"
                      [(ngModel)]="gatepassForm.serial_numbers" rows="3" required disabled></textarea>
            <div class="form-text">
              Prefilled by selection (serials only). You can edit before submit.
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" (click)="closeGatepassModal()">Cancel</button>
        <button class="btn btn-primary" type="button" (click)="submitGatepass()">Submit Gatepass</button>
      </div>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header text-white" style="background:#151433;">
        <h5 class="modal-title">Device Details — {{ selectedDetail?.serial_number }}</h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeDetailModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light fw-semibold">Device</div>
              <div class="card-body">
                <dl class="row mb-0">
                  <dt class="col-5">Serial No</dt><dd class="col-7">{{ selectedDetail?.serial_number || '-' }}</dd>
                  <dt class="col-5">Make</dt><dd class="col-7">{{ selectedDetail?.make || '-' }}</dd>
                  <dt class="col-5">Device Type</dt><dd class="col-7">{{ selectedDetail?.device_type || '-' }}</dd>
                  <dt class="col-5">Category</dt><dd class="col-7">{{ selectedDetail?.meter_category || '-' }}</dd>
                  <dt class="col-5">Phase</dt><dd class="col-7">{{ selectedDetail?.phase || '-' }}</dd>
                  <dt class="col-5">Inward No</dt><dd class="col-7">{{ selectedDetail?.inward_number || '-' }}</dd>
                  <dt class="col-5">Location</dt><dd class="col-7">{{ selectedDetail?.location_name || '-' }}</dd>
                </dl>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light fw-semibold">Testing</div>
              <div class="card-body">
                <dl class="row mb-0">
                  <dt class="col-5">Report ID</dt><dd class="col-7">{{ selectedDetail?.report_id || '-' }}</dd>
                  <dt class="col-5">Result</dt><dd class="col-7">{{ selectedDetail?.test_result || '-' }}</dd>
                  <dt class="col-5">Status</dt><dd class="col-7">{{ selectedDetail?.test_status || '-' }}</dd>
                  <dt class="col-5">Method</dt><dd class="col-7">{{ selectedDetail?.test_method || '-' }}</dd>
                  <dt class="col-5">Start</dt><dd class="col-7">{{ selectedDetail?.start_datetime | date:'short' }}</dd>
                  <dt class="col-5">End</dt><dd class="col-7">{{ selectedDetail?.end_datetime | date:'short' }}</dd>
                  <dt class="col-5">Remarks</dt><dd class="col-7">{{ selectedDetail?.details || '-' }}</dd>
                </dl>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light fw-semibold">Assignment</div>
              <div class="card-body">
                <dl class="row mb-0">
                  <dt class="col-5 col-md-3">Assigned Date</dt><dd class="col-7 col-md-9">{{ selectedDetail?.assigned_datetime | date:'short' }}</dd>
                  <dt class="col-5 col-md-3">Bench</dt><dd class="col-7 col-md-9">{{ selectedDetail?.bench_name || '-' }}</dd>
                  <dt class="col-5 col-md-3">Assigned To</dt><dd class="col-7 col-md-9">{{ selectedDetail?.user_name || '-' }}</dd>
                  <dt class="col-5 col-md-3">Assigned By</dt><dd class="col-7 col-md-9">{{ selectedDetail?.assigned_by_name || '-' }}</dd>
                </dl>
              </div>
            </div>
          </div>
        </div>        
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="closeDetailModal()">Close</button>
      </div>
    </div>
  </div>
</div>
