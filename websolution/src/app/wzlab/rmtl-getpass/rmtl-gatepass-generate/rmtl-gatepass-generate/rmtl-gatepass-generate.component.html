<!-- rmtl-gatepass-generate.component.html -->
<div class="container-fluid mt-4">
  <div class="card shadow border-0">
    <div class="card-header text-white d-flex justify-content-between align-items-center" style="background:#151433">
      <h5 class="mb-0">RMTL â€” Gatepass Generate</h5>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-secondary">From: {{ fromDate }}</span>
        <span class="badge bg-secondary">To: {{ toDate }}</span>
      </div>
    </div>

    <div class="card-body">
      <!-- Filters -->
      <div class="row g-3 align-items-end">
        <div class="col-sm-6 col-md-3">
          <label class="form-label fw-semibold">From Date</label>
          <input type="date" class="form-control" [(ngModel)]="fromDate" name="fromDate" (change)="onDatesChange()">
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label fw-semibold">To Date</label>
          <input type="date" class="form-control" [(ngModel)]="toDate" name="toDate" (change)="onDatesChange()">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Select Report ID</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
            <select class="form-select" [(ngModel)]="selectedReportId" name="report_id" (change)="onReportChange()">
              <option value="" disabled selected>Choose...</option>
              <option *ngFor="let id of reportIds" [value]="id">{{ id }}</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Loading / Errors -->
      <div class="mt-3" *ngIf="loadingList || loadingDevices">
        <div class="alert alert-info d-flex align-items-center gap-2 mb-0">
          <span class="spinner-border spinner-border-sm"></span>
          <span>Loading...</span>
        </div>
      </div>
      <div class="mt-3" *ngIf="!loadingList && !loadingDevices && errorMsg">
        <div class="alert alert-danger mb-0">{{ errorMsg }}</div>
      </div>

      <!-- Devices -->
      <div class="mt-4" *ngIf="!loadingDevices && devices.length">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
          <div class="form-check">
            <input id="selectAll" type="checkbox" class="form-check-input" [(ngModel)]="selectAll" (change)="toggleAllDevices()">
            <label class="form-check-label" for="selectAll">Select All</label>
          </div>
          <div class="small text-muted">
            Selected: <span class="fw-bold">{{ selectedCount }}</span> / {{ devices.length }}
          </div>
        </div>

      <div class="table-responsive border rounded">
  <table class="table table-hover align-middle mb-0">
    <thead class="table-light">
      <tr class="text-nowrap">
        <th style="width:60px;">Pick</th>
        <th>Device ID</th>
        <th>Report ID</th>
        <th>Result</th>
        <th>Status</th>
        <th>Method</th>
        <th>Start</th>
        <th>End</th>
        <th>Physical</th>
        <th>Seal</th>
        <th>Body</th>
        <th>Glass</th>
        <th>Terminal</th>
        <th>Other</th>
        <th>Details</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let d of devices; trackBy: trackByDeviceId">
        <td class="text-center">
          <input type="checkbox" [(ngModel)]="d.selected" (change)="onRowCheckboxChange()">
        </td>

        <td class="fw-semibold">{{ d.device_id }}</td>

        <td>
          <code class="small">{{ d.report_id }}</code>
        </td>

        <td>
          <span class="badge" [ngClass]="resultClass(d.test_result)">
            {{ d.test_result || '-' }}
          </span>
        </td>

        <td>
          <span class="badge" [ngClass]="statusClass(d.test_status)">
            {{ d.test_status || '-' }}
          </span>
        </td>

        <td>{{ d.test_method || '-' }}</td>

        <td>
          <span [title]="d.start_datetime">
            {{ d.start_datetime | date:'short' }}
          </span>
        </td>

        <td>
          <span [title]="d.end_datetime">
            {{ d.end_datetime | date:'short' }}
          </span>
        </td>

        <td>{{ d.physical_condition_of_device || '-' }}</td>
        <td>{{ d.seal_status || '-' }}</td>
        <td>{{ d.meter_body || '-' }}</td>
        <td>{{ d.meter_glass_cover || '-' }}</td>
        <td>{{ d.terminal_block || '-' }}</td>
        <td>{{ d.other || '-' }}</td>

        <td>
          <span class="d-inline-block text-truncate" style="max-width: 220px;" [title]="d.details">
            {{ d.details || '-' }}
          </span>
        </td>
      </tr>
    </tbody>
  </table>
</div>


        <div class="d-flex justify-content-end gap-2 mt-3">
       <button class="btn btn-outline-secondary" type="button" (click)="clearSelection()">    
         Clear Selection
          </button>
<button  class="btn btn-success"  type="button"  (click)="openGatepassModal()"  [disabled]="selectedCount === 0">
  Generate Gatepass
</button>

        </div>
      </div>

      <!-- Empty state -->
      <div class="mt-4" *ngIf="!loadingDevices && selectedReportId && devices.length === 0 && !errorMsg">
        <div class="alert alert-warning mb-0">
          No devices found for the selected report.
        </div>
      </div>

      <!-- Gatepass summary -->
      <div class="mt-4" *ngIf="gatepassInfo">
        <hr>
        <div class="table-responsive">
          <table class="table table-bordered table-sm">
            <thead class="table-light">
              <tr>
                <th colspan="4" class="text-primary">Gatepass Summary</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>Gatepass ID:/Report IDs:</th>
                <td>{{ gatepassInfo.id }} / {{ gatepassInfo.report_ids }}</td>
                <th>Receiver Name:</th>
                <td>{{ gatepassInfo.receiver_name }}</td>
              </tr>
              <tr>
                <th>Receiver Mobile:</th>
                <td>{{ gatepassInfo.receiver_mobile }}</td>
                <th>Dispatch Number:</th>
                <td>{{ gatepassInfo.dispatch_number }}</td>
              </tr>
              <tr>
                <th>Dispatch To:</th>
                <td>{{ gatepassInfo.dispatch_to }}</td>
                <th>Vehicle:</th>
                <td>{{ gatepassInfo.vehicle }}</td>
              </tr>
              <tr>
                <th>Created By:</th>
                <td>{{ gatepassInfo.created_by }}</td>
                <th>Created At:</th>
                <td>{{ gatepassInfo.created_at }}</td>
              </tr>
              <tr>
                <th></th>
                <td></td>
              </tr>
              <tr>
                <th>Serial Numbers:</th>
                <td  colspan="3">{{ gatepassInfo.serial_numbers }}</td>
              </tr>
            </tbody>
          </table>
          <div class="mt-3">
            <button class="btn btn-outline-primary" (click)="printGatepass()">  Download/Print Gatepass</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Gatepass Create Modal -->
<div class="modal fade" id="gatepassModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Gatepass</h5>
        <button type="button" class="btn-close" (click)="closeGatepassModal()"></button>
      </div>

      <div class="modal-body">
        <form #gpForm="ngForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Dispatch To</label>
              <input class="form-control" name="dispatch_to" [(ngModel)]="gatepassForm.dispatch_to" required>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Vehicle</label>
              <input class="form-control" name="vehicle" [(ngModel)]="gatepassForm.vehicle" required>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-semibold">Receiver Name</label>
              <input class="form-control" name="receiver_name" [(ngModel)]="gatepassForm.receiver_name" required>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">Receiver Designation</label>
              <input class="form-control" name="receiver_designation" [(ngModel)]="gatepassForm.receiver_designation" required>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-semibold">Receiver Mobile</label>
              <input class="form-control" name="receiver_mobile" [(ngModel)]="gatepassForm.receiver_mobile"
                     required pattern="^[0-9]{10}$" placeholder="10-digit mobile">
              <div class="form-text">Digits only, e.g. 9876543210</div>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Report ID(s)</label>
              <input class="form-control" name="report_ids" [(ngModel)]="gatepassForm.report_ids" readonly>
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Serial Numbers (make-wise)</label>
              <textarea class="form-control"
                        name="serial_numbers"
                        [(ngModel)]="gatepassForm.serial_numbers"
                        rows="3"
                        required></textarea>
              <div class="form-text">
                Prefilled by selection (format: <code>MAKE1: SN1, SN2 | MAKE2: SN3</code>). You can edit before submit.
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" (click)="closeGatepassModal()">Cancel</button>
        <button class="btn btn-primary" type="button" (click)="submitGatepass()">Submit Gatepass</button>
      </div>
    </div>
  </div>
</div>

