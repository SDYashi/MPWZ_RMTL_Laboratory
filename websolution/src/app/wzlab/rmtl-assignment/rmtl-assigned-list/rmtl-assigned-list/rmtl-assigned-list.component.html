<div class="container-fluid mt-4">
  <div class="card shadow-sm border-0">

    <!-- Header -->
    <div class="card-header text-white py-3" style="background: rgb(71, 175, 124); color:#fff;">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <h5 class="mb-0 d-flex align-items-center">
          <i class="fas fa-history me-2"></i>
          <span>RMTL — Assignment History</span>
        </h5>

        <!-- Quick stats (optional badges) -->
        <div class="d-none d-md-flex gap-2">
          <span class="badge bg-light text-dark">Total: {{ total }}</span>
          <span class="badge bg-info text-dark" *ngIf="selectedStatus">Status: {{ selectedStatus }}</span>
          <span class="badge bg-secondary" *ngIf="fromDate && toDate">{{ fromDate }} → {{ toDate }}</span>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="px-3 pt-3 pb-2">
      <div class="row g-3 align-items-end">
        <!-- Status -->
        <div class="col-12 col-sm-6 col-lg-3">
          <label class="form-label mb-1 fw-semibold">Status</label>
          <select class="form-select form-select-sm" [(ngModel)]="selectedStatus" (change)="loadHistory()">
            <option value="">All Statuses</option>
            <option *ngFor="let status of assignmentStatuses" [value]="status">{{ status }}</option>
          </select>
        </div>

        <!-- From/To -->
        <div class="col-12 col-sm-6 col-lg-5">
          <label class="form-label mb-1 fw-semibold">Date Range</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">From</span>
            <input type="date" class="form-control" [(ngModel)]="fromDate">
            <span class="input-group-text">To</span>
            <input type="date" class="form-control" [(ngModel)]="toDate">
            <button class="btn btn-outline-secondary" (click)="loadHistory()" title="Apply dates">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
        </div>

        <!-- Search -->
        <div class="col-12 col-lg-4">
          <label class="form-label mb-1 fw-semibold">Search</label>
          <div class="input-group input-group-sm">
            <input type="text" class="form-control" placeholder="Search by User or Device"
                   [(ngModel)]="searchTerm" (keyup.enter)="filterHistory()">
            <button class="btn btn-outline-secondary" (click)="filterHistory()">
              <i class="fas fa-search"></i>
            </button>
            <button class="btn btn-outline-secondary" (click)="searchTerm=''; filterHistory()" title="Clear">
              <i class="fas fa-times"></i>
            </button>
            <button class="btn btn-success" (click)="exportToExcel()" title="Export to Excel">
              <i class="fas fa-file-excel me-1"></i> Export
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card-body p-0">
      <div class="table-responsive" style="max-height: 60vh;">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light position-sticky top-0" style="z-index:1;">
            <tr>
              <th class="text-nowrap">#</th>
              <th class="text-nowrap">Inward No</th>
              <th class="text-nowrap">Device Serial No</th>
              <th class="text-nowrap">Device Type</th>
              <th class="text-nowrap">Status</th>
              <th class="text-nowrap">Assigned To</th>
              <th class="text-nowrap">Assigned By</th>
              <th class="text-nowrap">Assigned Date</th>
              <th class="text-nowrap">Bench</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of pagedHistory; let i = index">
              <td class="text-muted">{{ (page - 1) * pageSize + i + 1 }}</td>
              <td class="fw-semibold">{{ record.device?.inward_number || '—' }}</td>
              <td><code class="text-dark">{{ record.device?.serial_number || '—' }}</code></td>
              <td>{{ record.device?.device_type || '—' }}</td>
              <td>
                <span class="badge px-3 py-2"
                      [ngClass]="{
                        'bg-primary': record.assignment_status === 'ASSIGNED',
                        'bg-success': record.assignment_status === 'APPROVED',
                        'bg-warning text-dark': record.assignment_status === 'TESTED',
                        'bg-secondary': record.assignment_status === 'COMPLETED',
                        'bg-danger': record.assignment_status === 'REJECTED',
                        'bg-info text-dark': record.assignment_status === 'PENDING'
                      }">
                  {{ record.assignment_status }}
                </span>
              </td>
              <td>
                <div class="fw-semibold">{{ record.user_assigned?.name || '—' }}</div>
              </td>
              <td>
                <div class="fw-semibold">{{ record.assigned_by_user?.name || '—' }}</div>
              </td>
              <td>
                <span class="text-nowrap">{{ record.assigned_datetime | date: 'short' }}</span>
              </td>
              <td>{{ record.testing_bench?.bench_name || '—' }}</td>
            </tr>

            <tr *ngIf="pagedHistory.length === 0">
              <td colspan="9" class="text-center text-muted py-4">
                <i class="far fa-folder-open me-2"></i>No records found.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer / Pagination -->
    <div class="card-footer bg-white">
      <div class="row g-3 align-items-center">
        <!-- Page size -->
        <div class="col-12 col-md">
          <div class="d-flex align-items-center gap-2">
            <label class="form-label mb-0 text-muted">Rows per page</label>
            <select class="form-select form-select-sm w-auto" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
              <option value="5000">5000</option>
            </select>
            <div class="text-muted small ms-2">
              Showing <strong>{{ (total === 0) ? 0 : ((page - 1) * pageSize + 1) }}</strong>
              – <strong>{{ Math.min(page * pageSize, total) }}</strong> of
              <strong>{{ total }}</strong>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="col-12 col-md-auto ms-auto">
          <nav aria-label="Pagination">
            <ul class="pagination pagination-sm mb-0 flex-wrap justify-content-end">
              <li class="page-item" [class.disabled]="page === 1">
                <button class="page-link" (click)="goToPage(1)" title="First">&laquo;</button>
              </li>
              <li class="page-item" [class.disabled]="page === 1">
                <button class="page-link" (click)="goToPage(page - 1)" title="Previous">&lsaquo;</button>
              </li>

              <li class="page-item" *ngFor="let p of pages" [class.active]="p === page">
                <button class="page-link" (click)="goToPage(p)">{{ p }}</button>
              </li>

              <li class="page-item" [class.disabled]="page === totalPages">
                <button class="page-link" (click)="goToPage(page + 1)" title="Next">&rsaquo;</button>
              </li>
              <li class="page-item" [class.disabled]="page === totalPages">
                <button class="page-link" (click)="goToPage(totalPages)" title="Last">&raquo;</button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

  </div>
</div>
