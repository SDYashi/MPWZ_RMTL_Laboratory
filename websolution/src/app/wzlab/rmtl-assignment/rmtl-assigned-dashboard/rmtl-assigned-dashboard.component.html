<!-- Assignments -->
<div class="row g-3 mt-3" *ngIf="!isLoading; else loadingTpl">
  <div class="col-12">
    <div class="card shadow-sm border-0">

      <!-- Brand header -->
      <div class="card-header d-flex flex-wrap  justify-content-between align-items-center header-band">
        <div class="d-flex align-items-center">
          <h5 class="mb-0">Assignments Dashboard</h5>
        </div>
        <div class="d-flex align-items-center gap-3 kpi-pill">
          <span class="small text-white-50">Total</span>
          <strong class="fs-5 text-white">{{ number(assignments?.total_assignments) }}</strong>
        </div>
      </div>

      <div class="card-body">

        <!-- KPIs: Total + Status cards -->
        <div class="row g-3 mb-3">
          <div class="col-12 col-sm-6 col-md-4 col-xl-3">
            <div class="kpi-card p-3 h-100 bg-grad-secondary text-white">
              <div class="kpi-top">
                <span class="kpi-label">Total Assignments</span>
                <span class="kpi-chip">All</span>
              </div>
              <div class="kpi-value">{{ number(assignments?.total_assignments) }}</div>
            </div>
          </div>

          <!-- Use pre-sorted, strictly typed entries -->
          <div class="col-6 col-md-4 col-xl-3" *ngFor="let s of statusEntries">
            <div class="kpi-card p-3 h-100 text-white" [ngClass]="'bg-grad-' + statusColor(s.key)">
              <div class="kpi-top">
                <span class="kpi-label text-uppercase">{{ s.key }}</span>
                <span class="kpi-chip">Recent</span>
              </div>
              <div class="kpi-value">{{ number(s.value) }}</div>
            </div>
          </div>
        </div>

        <!-- User-wise cards -->
        <div *ngIf="assignments?.userwise_count?.length; else noUserwise">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">User-wise Counts</h6>
            <button class="btn btn-sm btn-outline-secondary"
                    *ngIf="(assignments?.userwise_count?.length || 0) > 8"
                    (click)="showAllUsers = !showAllUsers">
              {{ showAllUsers ? 'Show top 8' : 'Show all' }}
            </button>
          </div>

          <!-- Horizontal rail on mobile, grid on desktop -->
          <div class="user-rail row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xxl-6 g-3 mb-4">
            <div class="col" *ngFor="let u of userCards; trackBy: trackByUser">
              <div class="user-card h-100">
                <div class="user-card-body">
                  <div class="user-count text-{{ userColor(u.user_id, u.user_id) }}">{{ number(u.count) }}</div>
                  <div class="text-muted small">Assignments</div>
                  <div class="mt-3">
                    <span class="badge rounded-pill bg-light text-dark border px-3 py-1">
                      User #{{ u.user_id }}
                    </span>
                  </div>
                  <div class="deco-bubble"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <ng-template #noUserwise>
          <div class="text-muted">No user-wise data.</div>
        </ng-template>

        <!-- Recent history -->
        <div *ngIf="recent10.length; else noRecent">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Recent Assignment History</h6>
            <span class="text-muted small">Showing {{ recent10.length | number }} of {{ (assignments?.recent_assignment_history?.length || 0) | number }}</span>
          </div>

          <div class="table-responsive soft-table">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Device</th>
                  <th>User</th>
                  <th>Status</th>
                  <th>Assigned</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let r of recent10; trackBy: trackByHist">
                  <td class="fw-semibold">{{ r.id }}</td>
                  <td>#{{ r.device_id }}</td>
                  <td>User #{{ r.user_id }}</td>
                  <td>
                    <span class="badge" [ngClass]="statusBadgeClass(r.assignment_status)">
                      {{ r.assignment_status }}
                    </span>
                  </td>
                  <td><small class="text-muted">{{ r.assigned_datetime | date:'medium' }}</small></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <ng-template #noRecent>
          <div class="text-muted">No recent assignment history.</div>
        </ng-template>

      </div>
    </div>
  </div>
</div>

<!-- Loading skeleton -->
<ng-template #loadingTpl>
  <div class="row g-3 mt-3">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white">
          <h5 class="mb-0 placeholder-glow"><span class="placeholder col-3"></span></h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6 col-md-4 col-lg-3" *ngFor="let i of [1,2,3,4,5,6,7,8]">
              <div class="kpi-card p-3">
                <div class="placeholder-glow">
                  <span class="placeholder col-6"></span>
                  <div class="mt-2"><span class="placeholder col-4"></span></div>
                </div>
              </div>
            </div>
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-sm">
              <thead>
                <tr><th class="placeholder col-2"></th><th class="placeholder col-2"></th><th class="placeholder col-2"></th><th class="placeholder col-2"></th><th class="placeholder col-2"></th></tr>
              </thead>
              <tbody>
                <tr *ngFor="let i of [1,2,3,4,5]">
                  <td class="placeholder col-2"></td>
                  <td class="placeholder col-2"></td>
                  <td class="placeholder col-2"></td>
                  <td class="placeholder col-2"></td>
                  <td class="placeholder col-2"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>
