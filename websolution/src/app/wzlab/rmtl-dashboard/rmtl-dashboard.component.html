<div class="container-fluid py-2">

  <!-- HEADER BAR -->
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 px-3 py-2 rounded shadow-sm bg-white">
    <div class="d-flex align-items-center gap-3 mb-2 mb-lg-0">
      <img src="../../assets/icons/wzlogo.png" alt="wzlogo" width="40" height="40" />
      <div>
        <h1 class="h4 mb-0 fw-semibold">RMTL Laboratory Dashboard</h1>
        <div class="text-muted small" *ngIf="mainData?.generated_at || storeData?.generated_at || testingData?.generated_at">
          Updated:
          {{ mainData?.generated_at || storeData?.generated_at || testingData?.generated_at }}
        </div>
      </div>
    </div>

    <div class="text-end">
      <button class="btn btn-sm btn-outline-primary me-2" (click)="reloadAll()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
      <button class="btn btn-outline-secondary btn-sm" (click)="onLogout()">
        <i class="fas fa-sign-out-alt me-1"></i> Logout
      </button>
    </div>
  </div>

  <!-- Loading / Error -->
  <div *ngIf="isLoading" class="alert alert-light border d-flex align-items-center gap-2">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Loading dashboardâ€¦</span>
  </div>

  <div *ngIf="!isLoading && error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- ===================== MAIN DASHBOARD ===================== -->
  <div *ngIf="!isLoading && !error && mainData" class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0 fw-semibold">Main Dashboard</h5>
      <span class="badge bg-primary">/dashboard/main</span>
    </div>

    <!-- MAIN KPIs -->
    <div class="row g-3">
      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Inwards Device</div>
            <div class="h5 fw-bold mb-0">{{ number(mainData.counts?.inwards_device) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Dispatched Devices</div>
            <div class="h5 fw-bold mb-0">{{ number(mainData.counts?.dispatched_devices) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Assigned For Testing</div>
            <div class="h5 fw-bold mb-0">{{ number(mainData.counts?.assigned_for_testing) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Not Assigned For Testing</div>
            <div class="h5 fw-bold mb-0">{{ number(mainData.counts?.not_assigned_for_testing) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Testing Completed</div>
            <div class="h5 fw-bold mb-0">{{ number(mainData.counts?.testing_completed) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Testing Pending</div>
            <div class="h5 fw-bold mb-0">{{ number(mainData.counts?.testing_pending) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Pending For Approval</div>
            <div class="h5 fw-bold mb-0">{{ number(mainData.counts?.pending_for_approval) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Approval Done</div>
            <div class="h5 fw-bold mb-0">{{ number(mainData.counts?.approval_done) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mt-3">
      <div class="col-12 col-xl-6">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-white border-0">
            <div class="fw-semibold">Devices by Type</div>
            <div class="text-muted small">Total received</div>
          </div>
          <div class="card-body">
            <div style="height:260px; position:relative;">
              <canvas id="devicesByTypeChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-6">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-white border-0">
            <div class="fw-semibold">Testing Progress</div>
            <div class="text-muted small">Completed vs Total</div>
          </div>
          <div class="card-body">
            <div style="height:260px; position:relative;">
              <canvas id="testingProgressChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-white border-0">
            <div class="fw-semibold">Assignment %</div>
            <div class="text-muted small">Assigned / Total per type</div>
          </div>
          <div class="card-body">
            <div style="height:260px; position:relative;">
              <canvas id="assignmentPctChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-8">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-white border-0">
            <div class="fw-semibold">Inwarded per Day</div>
            <div class="text-muted small">Single / Three Phase only</div>
          </div>
          <div class="card-body">
            <div style="height:260px; position:relative;">
              <canvas id="inwardPerDayChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Userwise tables -->
    <div class="row g-3 mt-3">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white fw-semibold">Testing Users Summary</div>
          <div class="card-body table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Total Assigned</th>
                  <th>Done</th>
                  <th>Pending</th>
                  <th>Approved</th>
                  <th>Pending Approval</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let u of mainData.userwise?.testing_users">
                  <td>{{ u.name }}</td>
                  <td>{{ u.total_assigned }}</td>
                  <td>{{ u.testing_done }}</td>
                  <td>{{ u.testing_pending }}</td>
                  <td>{{ u.approved }}</td>
                  <td>{{ u.pending_approval }}</td>
                </tr>
                <tr *ngIf="(mainData.userwise?.testing_users?.length || 0) === 0">
                  <td colspan="6" class="text-center text-muted">No records</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white fw-semibold">OIC Users Summary</div>
          <div class="card-body table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Total Assigned By Me</th>
                  <th>Not Assigned</th>
                  <th>Approved</th>
                  <th>Pending Approval</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let u of mainData.userwise?.oic_users">
                  <td>{{ u.name }}</td>
                  <td>{{ u.total_assigned_by_me }}</td>
                  <td>{{ u.not_assigned }}</td>
                  <td>{{ u.approved }}</td>
                  <td>{{ u.pending_approval }}</td>
                </tr>
                <tr *ngIf="(mainData.userwise?.oic_users?.length || 0) === 0">
                  <td colspan="5" class="text-center text-muted">No records</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white fw-semibold">Store Users Summary</div>
          <div class="card-body table-responsive">
            <table class="table table-sm table-bordered align-middle">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Inwarded By Me</th>
                  <th>Dispatched By Me</th>
                  <th>Pending Assignment</th>
                  <th>Pending Dispatch After Approval</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let u of mainData.userwise?.store_users">
                  <td>{{ u.name }}</td>
                  <td>{{ u.inwarded_by_me }}</td>
                  <td>{{ u.dispatched_by_me }}</td>
                  <td>{{ u.pending_assignment }}</td>
                  <td>{{ u.pending_dispatch_after_approval }}</td>
                </tr>
                <tr *ngIf="(mainData.userwise?.store_users?.length || 0) === 0">
                  <td colspan="5" class="text-center text-muted">No records</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ===================== STORE DASHBOARD ===================== -->
  <div *ngIf="!isLoading && !error && storeData" class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0 fw-semibold">Store Dashboard</h5>
      <span class="badge bg-success">/dashboard/store-user</span>
    </div>

    <div class="row g-3">
      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Total Inwards</div>
            <div class="h5 fw-bold mb-0">{{ number(storeData.counts?.total_inwards) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Total Dispatched</div>
            <div class="h5 fw-bold mb-0">{{ number(storeData.counts?.total_dispatched) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Pending Assignment</div>
            <div class="h5 fw-bold mb-0">{{ number(storeData.counts?.pending_for_assignment) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Pending Dispatch After Approval</div>
            <div class="h5 fw-bold mb-0">{{ number(storeData.counts?.pending_for_dispatch_after_testing_done) }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0 mt-3">
      <div class="card-header bg-white fw-semibold">Store Pending Devices</div>
      <div class="card-body table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Serial</th>
              <th>Inward No</th>
              <th>Inward Date</th>
              <th>Purpose</th>
              <th>Category</th>
              <th>Phase</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of storeData.pending_devices">
              <td>{{ d.serial_number }}</td>
              <td>{{ d.inward_number }}</td>
              <td>{{ d.inward_date }}</td>
              <td>{{ d.device_testing_purpose }}</td>
              <td>{{ d.meter_category }}</td>
              <td>{{ d.phase }}</td>
            </tr>
            <tr *ngIf="(storeData.pending_devices?.length || 0) === 0">
              <td colspan="6" class="text-center text-muted">No pending devices</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===================== TESTING DASHBOARD ===================== -->
  <div *ngIf="!isLoading && !error && testingData" class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0 fw-semibold">Testing Dashboard</h5>
      <span class="badge bg-warning text-dark">/dashboard/testing-user</span>
    </div>

    <div class="row g-3">
      <div class="col-6 col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Total Assigned</div>
            <div class="h5 fw-bold mb-0">{{ number(testingData.counts?.total_assigned) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Total Tested</div>
            <div class="h5 fw-bold mb-0">{{ number(testingData.counts?.total_tested) }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small">Pending For Tested</div>
            <div class="h5 fw-bold mb-0">{{ number(testingData.counts?.pending_for_tested) }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0 mt-3">
      <div class="card-header bg-white fw-semibold">Pending Assignments For Testing</div>
      <div class="card-body table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Serial</th>
              <th>Inward No</th>
              <th>Inward Date</th>
              <th>Purpose</th>
              <th>Category</th>
              <th>Phase</th>
              <th>Assigned Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of testingData.pending_devices">
              <td>{{ d.serial_number }}</td>
              <td>{{ d.inward_number }}</td>
              <td>{{ d.inward_date }}</td>
              <td>{{ d.device_testing_purpose }}</td>
              <td>{{ d.meter_category }}</td>
              <td>{{ d.phase }}</td>
              <td>{{ d.assigned_datetime }}</td>
            </tr>
            <tr *ngIf="(testingData.pending_devices?.length || 0) === 0">
              <td colspan="7" class="text-center text-muted">No pending assignments</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
