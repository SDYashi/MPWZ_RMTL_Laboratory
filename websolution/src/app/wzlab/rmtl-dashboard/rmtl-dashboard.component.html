<div class="container-fluid py-2">

  <!-- HEADER BAR -->
  <div
    class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 px-3 py-2 rounded shadow-sm bg-white"
  >
    <div class="d-flex align-items-center gap-3 mb-2 mb-lg-0">
      <img
        src="../../assets/icons/wzlogo.png"
        alt="wzlogo"
        width="40"
        height="40"
      />
      <h1 class="h4 mb-0 fw-semibold">RMTL Laboratory Dashboard</h1>
    </div>

    <div class="text-end">
      <button class="btn btn-sm btn-outline-primary me-2" (click)="reloadAll()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>

      <button class="btn btn-outline-primary btn-sm me-2">
        <i class="fas fa-download me-1"></i> Export
      </button>

      <button class="btn btn-outline-secondary btn-sm" (click)="onLogout()">
        <i class="fas fa-sign-out-alt me-1"></i> Logout
      </button>
    </div>
  </div>

  <!-- Loading / Error -->
  <div
    *ngIf="isLoading"
    class="alert alert-light border d-flex align-items-center gap-2"
  >
    <i class="fas fa-spinner fa-spin"></i>
    <span>Loading dashboardâ€¦</span>
  </div>

  <div *ngIf="!isLoading && error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- PRIMARY KPIs -->
  <div class="row g-3 mt-3" *ngIf="!isLoading && !error">
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-primary text-white p-3">
            <i class="fas fa-box"></i>
          </div>
          <div>
            <div class="fw-bold h5 mb-0">{{ number(counts?.inwards) }}</div>
            <div class="text-muted small">Total Inwards</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-info text-white p-3">
            <i class="fas fa-truck"></i>
          </div>
          <div>
            <div class="fw-bold h5 mb-0">
              {{ number(counts?.dispatcheds) }}
            </div>
            <div class="text-muted small">Dispatched</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-success text-white p-3">
            <i class="fas fa-clipboard-list"></i>
          </div>
          <div>
            <div class="fw-bold h5 mb-0">
              {{ number(counts?.assignments) }}
            </div>
            <div class="text-muted small">Assignments</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-dark text-white p-3">
            <i class="fas fa-vial"></i>
          </div>
          <div>
            <div class="fw-bold h5 mb-0">
              {{ number(counts?.testings) }}
            </div>
            <div class="text-muted small">Testings</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECONDARY KPIs -->
  <div class="row g-3 mt-1" *ngIf="!isLoading && !error">
    <div
      class="col-6 col-sm-4 col-lg-2"
      *ngFor="let i of secondaryCards"
    >
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-secondary text-white p-3">
            <i class="fas" [ngClass]="i.icon"></i>
          </div>
          <div>
            <div class="fw-bold">
              {{ number(getCount(i.key)) }}
            </div>
            <div class="text-muted small">{{ i.label }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-primary text-white p-3">
            <i class="fas fa-ticket-alt"></i>
          </div>
          <div>
            <div class="fw-bold">
              {{ number(counts?.gatepasses) }}
            </div>
            <div class="text-muted small">Gatepasses</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-success text-white p-3">
            <i class="fas fa-thumbs-up"></i>
          </div>
          <div>
            <div class="fw-bold">
              {{ number(counts?.approved_statuses) }}
            </div>
            <div class="text-muted small">Approved</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-warning text-white p-3">
            <i class="fas fa-hourglass-half"></i>
          </div>
          <div>
            <div class="fw-bold">
              {{ number(counts?.pending_approvals) }}
            </div>
            <div class="text-muted small">Pending Approvals</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-success text-white p-3">
            <i class="fas fa-check-circle"></i>
          </div>
          <div>
            <div class="fw-bold">
              {{ number(testingCompleted) }}
            </div>
            <div class="text-muted small">Completed</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-secondary text-white p-3">
            <i class="fas fa-ban"></i>
          </div>
          <div>
            <div class="fw-bold">
              {{ number(testingUntestable) }}
            </div>
            <div class="text-muted small">Untestable</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHARTS ROWS -->
  <div
    class="container-fluid py-2 mt-2"
    *ngIf="!isLoading && !error"
  >
    <!-- ROW: BAR CHARTS -->
    <div class="row g-3 mb-4">
      <!-- Devices by Type -->
      <div class="col-12 col-xl-6">
        <div class="card shadow-sm border-0 h-100">
          <div
            class="card-header bg-white border-0 d-flex justify-content-between align-items-center"
          >
            <div>
              <div class="fw-semibold">Devices by Type</div>
              <div class="text-muted small">Total received</div>
            </div>
          </div>
          <div class="card-body">
            <div style="height:260px; position:relative;">
              <canvas id="devicesByTypeChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Testing Progress -->
      <div class="col-12 col-xl-6">
        <div class="card shadow-sm border-0 h-100">
          <div
            class="card-header bg-white border-0 d-flex justify-content-between align-items-center"
          >
            <div>
              <div class="fw-semibold">Testing Progress</div>
              <div class="text-muted small">
                Completed vs Total
              </div>
            </div>
          </div>
          <div class="card-body">
            <div style="height:260px; position:relative;">
              <canvas id="testingProgressChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ROW: ASSIGNMENT & LINE -->
    <div class="row g-3 mb-4">
      <!-- Assignment % -->
      <div class="col-12 col-xl-4">
        <div class="card shadow-sm border-0 h-100">
          <div
            class="card-header bg-white border-0 d-flex justify-content-between align-items-center"
          >
            <div>
              <div class="fw-semibold">Assignment %</div>
              <div class="text-muted small">
                Assigned / Total per device type
              </div>
            </div>
          </div>
          <div class="card-body">
            <div style="height:260px; position:relative;">
              <canvas id="assignmentPctChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Line chart inward per day -->
      <div class="col-12 col-xl-8">
        <div class="card shadow-sm border-0 h-100">
          <div
            class="card-header bg-white border-0 d-flex justify-content-between align-items-center"
          >
            <div>
              <div class="fw-semibold">Inwarded per Day</div>
              <div class="text-muted small">
                Single Phase / Three Phase only
              </div>
            </div>
          </div>
          <div class="card-body">
            <div style="height:260px; position:relative;">
              <canvas id="inwardPerDayChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RECENT HISTORY TABLES -->
  <!-- <div class="row g-3 mt-3" *ngIf="!isLoading && !error">
    <div
      class="col-12 col-xl-6"
      *ngFor="let cfg of tablesConfig; trackBy: trackByIdx"
    >
      <div
        class="card shadow-sm border-0 rounded-4 h-100"
      >
        <div
          class="card-header bg-white border-0 py-3 d-flex align-items-center justify-content-between"
        >
          <div class="d-flex align-items-center gap-2">
            <i class="fas" [ngClass]="cfg.icon"></i>
            <h5 class="mb-0">{{ cfg.title }}</h5>
          </div>
          <span class="text-muted small"
            >Rows:
            {{ getList(cfg.key).length | number }}</span
          >
        </div>

        <div class="card-body pt-0">
          <ng-container
            *ngIf="deriveCols(getList(cfg.key)) as cols"
          >
            <div class="table-responsive soft-max-h">
              <table
                class="table table-sm table-hover align-middle"
              >
                <thead
                  class="table-light sticky-thead"
                >
                  <tr>
                    <th
                      *ngFor="let c of cols; trackBy: trackByIdx"
                    >
                      {{ prettify(c) }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let row of getList(cfg.key); trackBy: trackByIdx"
                  >
                    <td
                      *ngFor="let c of cols; trackBy: trackByIdx"
                    >
                      <span
                        class="text-truncate-1 d-inline-block"
                        >{{ cell(row, c) }}</span
                      >
                    </td>
                  </tr>

                  <tr
                    *ngIf="!getList(cfg.key).length"
                  >
                    <td
                      [attr.colspan]="cols.length"
                      class="text-center text-muted"
                    >
                      No data
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div> -->
</div>
