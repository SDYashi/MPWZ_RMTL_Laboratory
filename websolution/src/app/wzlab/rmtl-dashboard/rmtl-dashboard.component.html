<div class="container-fluid py-2">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 px-3 py-2 rounded shadow-sm bg-white">
    <div class="d-flex align-items-center gap-3">
      <img src="../../assets/icons/wzlogo.png" alt="wzlogo" width="40" height="40" />
      <h1 class="h4 mb-0 fw-semibold">RMTL Laboratory Dashboard</h1>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm">
        <i class="fas fa-download me-1"></i> Export
      </button>
      <button class="btn btn-outline-secondary btn-sm" (click)="onLogout()">
        <i class="fas fa-sign-out-alt me-1"></i> Logout
      </button>
    </div>
  </div>

  <!-- Loading / Error -->
  <div *ngIf="isLoading" class="alert alert-light border d-flex align-items-center gap-2">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Loading dashboardâ€¦</span>
  </div>
  <div *ngIf="!isLoading && error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- Primary KPIs -->
  <div class="row g-3" *ngIf="!isLoading">
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-primary text-white p-3"><i class="fas fa-box"></i></div>
          <div>
            <div class="fw-bold h5 mb-0">{{ number(counts?.inwards) }}</div>
            <div class="text-muted small">Total Inwards</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-info text-white p-3"><i class="fas fa-truck"></i></div>
          <div>
            <div class="fw-bold h5 mb-0">{{ number(counts?.dispatcheds) }}</div>
            <div class="text-muted small">Dispatched</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-success text-white p-3"><i class="fas fa-clipboard-list"></i></div>
          <div>
            <div class="fw-bold h5 mb-0">{{ number(counts?.assignments) }}</div>
            <div class="text-muted small">Assignments</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-dark text-white p-3"><i class="fas fa-vial"></i></div>
          <div>
            <div class="fw-bold h5 mb-0">{{ number(counts?.testings) }}</div>
            <div class="text-muted small">Testings</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Secondary KPIs -->
  <div class="row g-3 mt-1" *ngIf="!isLoading">
    <div class="col-6 col-sm-4 col-lg-2" *ngFor="let i of secondaryCards">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-secondary text-white p-3"><i class="fas" [ngClass]="i.icon"></i></div>
          <div>
            <div class="fw-bold">{{ number(getCount(i.key)) }}</div>
            <div class="text-muted small">{{ i.label }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gatepasses -->
    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-primary text-white p-3"><i class="fas fa-ticket-alt"></i></div>
          <div>
            <div class="fw-bold">{{ number(counts?.gatepasses) }}</div>
            <div class="text-muted small">Gatepasses</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Approved -->
    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-success text-white p-3"><i class="fas fa-thumbs-up"></i></div>
          <div>
            <div class="fw-bold">{{ number(counts?.approved_statuses) }}</div>
            <div class="text-muted small">Approved</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pending Approvals -->
    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-warning text-white p-3"><i class="fas fa-hourglass-half"></i></div>
          <div>
            <div class="fw-bold">{{ number(counts?.pending_approvals) }}</div>
            <div class="text-muted small">Pending Approvals</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Untestable -->
    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-primary text-white p-3"><i class="fas fa-trophy"></i></div>
          <div>
            <div class="fw-bold">{{ number(testingUntestable) }}</div>
            <div class="text-muted small">Untestable</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Completed -->
    <div class="col-6 col-sm-4 col-lg-2">
      <div class="card border-0 shadow-sm h-100 hover-card">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="rounded-3 bg-success text-white p-3"><i class="fas fa-check-circle"></i></div>
          <div>
            <div class="fw-bold">{{ number(testingCompleted) }}</div>
            <div class="text-muted small">Completed</div>
          </div>
        </div>
      </div>
    </div>
  </div>




  <!-- Stock Status -->
  <div class="row g-3 mt-3" *ngIf="!isLoading">
    <div class="col-12 col-xl-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recent Inwards</h5>
          <span class="small text-muted">Total Inwards: {{ number(stock?.inward) }}</span>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Serial</th>
                  <th>Make</th>
                  <th>Type</th>
                  <th>Location</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let d of stock?.recent_inwards | slice:0:10">
                  <td>{{ d.serial_number || '-' }}</td>
                  <td>{{ d.make || '-' }}</td>
                  <td>{{ d.meter_type || d.device_type || '-' }}</td>
                  <td>{{ d.location_name || '-' }}</td>
                  <td><small class="text-muted">{{ d.inward_date || '-' }}</small></td>
                </tr>
                <tr *ngIf="!(stock?.recent_inwards?.length)">
                  <td colspan="5" class="text-center text-muted">No recent inwards.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recent Dispatched</h5>
          <span class="small text-muted">Total Dispatched: {{ number(stock?.dispatched) }}</span>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Serial</th>
                  <th>Make</th>
                  <th>Type</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let d of stock?.recent_dispatcheds | slice:0:10">
                  <td>{{ d.serial_number || '-' }}</td>
                  <td>{{ d.make || '-' }}</td>
                  <td>{{ d.meter_type || d.device_type || '-' }}</td>
                  <td><small class="text-muted">{{ d.dispatch_date || '-' }}</small></td>
                </tr>
                <tr *ngIf="!(stock?.recent_dispatcheds?.length)">
                  <td colspan="4" class="text-center text-muted">No recent dispatched devices.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Recent History (Modern) -->
<div class="row g-3 g-xl-4 mt-3" *ngIf="!isLoading">
  <!-- Recent Entities (Tabs) -->
  <div class="col-12 col-xl-6 col-xxl-6">
    <div class="card shadow-sm border-0 h-100 rounded-4">
      <div class="card-header bg-white border-0 py-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <span class="hdr-dot bg-info"></span>
          <h5 class="mb-0">Recent Entities</h5>
        </div>
        <!-- quick filter tabs -->
        <ul class="nav nav-pills nav-fill gap-2 small entities-tabs" id="entitiesTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-devices" data-bs-toggle="pill" data-bs-target="#pane-devices" type="button" role="tab">Devices</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-users" data-bs-toggle="pill" data-bs-target="#pane-users" type="button" role="tab">Users</button>
          </li>
          <li class="nav-item d-none d-md-block" role="presentation">
            <button class="nav-link" id="tab-benches" data-bs-toggle="pill" data-bs-target="#pane-benches" type="button" role="tab">Benches</button>
          </li>
          <li class="nav-item d-none d-md-block" role="presentation">
            <button class="nav-link" id="tab-stores" data-bs-toggle="pill" data-bs-target="#pane-stores" type="button" role="tab">Stores</button>
          </li>
          <li class="nav-item d-none d-xl-block" role="presentation">
            <button class="nav-link" id="tab-vendors" data-bs-toggle="pill" data-bs-target="#pane-vendors" type="button" role="tab">Vendors</button>
          </li>
          <li class="nav-item d-none d-xl-block" role="presentation">
            <button class="nav-link" id="tab-offices" data-bs-toggle="pill" data-bs-target="#pane-offices" type="button" role="tab">Offices</button>
          </li>
        </ul>
      </div>

      <div class="card-body pt-0">
        <div class="tab-content">
          <!-- Devices -->
          <div class="tab-pane fade show active" id="pane-devices" role="tabpanel" aria-labelledby="tab-devices">
            <ul class="list-group list-group-flush small">
              <li class="list-group-item py-2 d-flex align-items-center gap-2" *ngFor="let x of firstN(recent?.recent_devices, 8)">
                <i class="fas fa-microchip text-primary"></i>
                <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
              </li>
              <li class="list-group-item text-muted py-2" *ngIf="!(recent?.recent_devices?.length)">No data</li>
            </ul>
          </div>

          <!-- Users -->
          <div class="tab-pane fade" id="pane-users" role="tabpanel" aria-labelledby="tab-users">
            <ul class="list-group list-group-flush small  ">
              <li class="list-group-item py-2 d-flex align-items-center gap-2" *ngFor="let x of firstN(recent?.recent_users, 8)">
                <i class="fas fa-user text-secondary"></i>
                <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
              </li>
              <li class="list-group-item text-muted py-2" *ngIf="!(recent?.recent_users?.length)">No data</li>
            </ul>
          </div>

          <!-- Benches -->
          <div class="tab-pane fade" id="pane-benches" role="tabpanel" aria-labelledby="tab-benches">
            <ul class="list-group list-group-flush small  ">
              <li class="list-group-item py-2 d-flex align-items-center gap-2" *ngFor="let x of firstN(recent?.recent_benches, 8)">
                <i class="fas fa-vials text-info"></i>
                <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
              </li>
              <li class="list-group-item text-muted py-2" *ngIf="!(recent?.recent_benches?.length)">No data</li>
            </ul>
          </div>

          <!-- Stores -->
          <div class="tab-pane fade" id="pane-stores" role="tabpanel" aria-labelledby="tab-stores">
            <ul class="list-group list-group-flush small  ">
              <li class="list-group-item py-2 d-flex align-items-center gap-2" *ngFor="let x of firstN(recent?.recent_stores, 8)">
                <i class="fas fa-store text-success"></i>
                <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
              </li>
              <li class="list-group-item text-muted py-2" *ngIf="!(recent?.recent_stores?.length)">No data</li>
            </ul>
          </div>

          <!-- Vendors -->
          <div class="tab-pane fade" id="pane-vendors" role="tabpanel" aria-labelledby="tab-vendors">
            <ul class="list-group list-group-flush small  ">
              <li class="list-group-item py-2 d-flex align-items-center gap-2" *ngFor="let x of firstN(recent?.recent_vendors, 8)">
                <i class="fas fa-handshake text-warning"></i>
                <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
              </li>
              <li class="list-group-item text-muted py-2" *ngIf="!(recent?.recent_vendors?.length)">No data</li>
            </ul>
          </div>

          <!-- Offices -->
          <div class="tab-pane fade" id="pane-offices" role="tabpanel" aria-labelledby="tab-offices">
            <ul class="list-group list-group-flush small  ">
              <li class="list-group-item py-2 d-flex align-items-center gap-2" *ngFor="let x of firstN(recent?.recent_offices, 8)">
                <i class="fas fa-building text-danger"></i>
                <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
              </li>
              <li class="list-group-item text-muted py-2" *ngIf="!(recent?.recent_offices?.length)">No data</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Workflow Events (Accordion Timeline) -->
  <div class="col-12 col-xxl-6">
    <div class="card shadow-sm border-0 h-100 rounded-4">
      <div class="card-header bg-white border-0 py-3 d-flex align-items-center gap-2">
        <span class="hdr-dot bg-success"></span>
        <h5 class="mb-0">Recent Workflow Events</h5>
      </div>

      <div class="card-body pt-1">
        <div class="accordion accordion-flush" id="wfAccordion">
          <!-- Inwards -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="wf-inwards-h">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wf-inwards" aria-expanded="false">
                <i class="fas fa-arrow-down me-2 text-success"></i> Inwards
              </button>
            </h2>
            <div id="wf-inwards" class="accordion-collapse collapse" data-bs-parent="#wfAccordion">
              <div class="accordion-body pt-2">
                <ul class="timeline small">
                  <li *ngFor="let x of firstN(recent?.recent_inwards, 6)">
                    <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
                  </li>
                  <li class="text-muted" *ngIf="!(recent?.recent_inwards?.length)">No data</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Dispatched -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="wf-disp-h">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wf-disp" aria-expanded="false">
                <i class="fas fa-arrow-up me-2 text-primary"></i> Dispatched
              </button>
            </h2>
            <div id="wf-disp" class="accordion-collapse collapse" data-bs-parent="#wfAccordion">
              <div class="accordion-body pt-2">
                <ul class="timeline small">
                  <li *ngFor="let x of firstN(recent?.recent_gatepasses, 6)">
                    <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
                  </li>
                  <li class="text-muted" *ngIf="!(recent?.recent_gatepasses?.length)">No data</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Assignments -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="wf-assign-h">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wf-assign" aria-expanded="false">
                <i class="fas fa-tasks me-2 text-secondary"></i> Assignments
              </button>
            </h2>
            <div id="wf-assign" class="accordion-collapse collapse" data-bs-parent="#wfAccordion">
              <div class="accordion-body pt-2">
                <ul class="timeline small">
                  <li *ngFor="let x of firstN(recent?.recent_assignments, 6)">
                    <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
                  </li>
                  <li class="text-muted" *ngIf="!(recent?.recent_assignments?.length)">No data</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Testings -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="wf-test-h">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wf-test" aria-expanded="false">
                <i class="fas fa-vial me-2 text-info"></i> Testings
              </button>
            </h2>
            <div id="wf-test" class="accordion-collapse collapse" data-bs-parent="#wfAccordion">
              <div class="accordion-body pt-2">
                <ul class="timeline small">
                  <li *ngFor="let x of firstN(recent?.recent_testings, 6)">
                    <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
                  </li>
                  <li class="text-muted" *ngIf="!(recent?.recent_testings?.length)">No data</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Approvals -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="wf-approvals-h">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wf-approvals" aria-expanded="false">
                <i class="fas fa-thumbs-up me-2 text-success"></i> Approvals
              </button>
            </h2>
            <div id="wf-approvals" class="accordion-collapse collapse" data-bs-parent="#wfAccordion">
              <div class="accordion-body pt-2">
                <ul class="timeline small">
                  <li *ngFor="let x of firstN(recent?.recent_approvals, 6)">
                    <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
                  </li>
                  <li class="text-muted" *ngIf="!(recent?.recent_approvals?.length)">No data</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Tested -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="wf-tested-h">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wf-tested" aria-expanded="false">
                <i class="fas fa-check me-2 text-dark"></i> Tested
              </button>
            </h2>
            <div id="wf-tested" class="accordion-collapse collapse" data-bs-parent="#wfAccordion">
              <div class="accordion-body pt-2">
                <ul class="timeline small">
                  <li *ngFor="let x of firstN(recent?.recent_tested, 6)">
                    <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
                  </li>
                  <li class="text-muted" *ngIf="!(recent?.recent_tested?.length)">No data</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Gatepasses -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="wf-gp-h">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wf-gp" aria-expanded="false">
                <i class="fas fa-ticket-alt me-2 text-warning"></i> Gatepasses
              </button>
            </h2>
            <div id="wf-gp" class="accordion-collapse collapse" data-bs-parent="#wfAccordion">
              <div class="accordion-body pt-2">
                <ul class="timeline small">
                  <li *ngFor="let x of firstN(recent?.recent_gatepasses, 6)">
                    <span class="text-truncate" title="{{ x.text }}">{{ x.text }}</span>
                  </li>
                  <li class="text-muted" *ngIf="!(recent?.recent_gatepasses?.length)">No data</li>
                </ul>
              </div>
            </div>
          </div>

        </div> <!-- /accordion -->
      </div>
    </div>
  </div>
</div>


</div>
